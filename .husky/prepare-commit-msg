#!/usr/bin/env bash
# prepare-commit-msg - Appends ticket context to commit messages
#
# This hook runs before the commit message editor opens.
# It adds ticket information from Brain Dump when:
# 1. The branch name contains a ticket UUID
# 2. The commit is not a merge, squash, or amend

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"  # message, template, merge, squash, commit (amend)

# Skip for merge commits, squash commits, and amends
if [[ "$COMMIT_SOURCE" == "merge" ]] || [[ "$COMMIT_SOURCE" == "squash" ]] || [[ "$COMMIT_SOURCE" == "commit" ]]; then
  exit 0
fi

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

# Check if get-ticket-context.sh exists
CONTEXT_SCRIPT="$SCRIPT_DIR/scripts/get-ticket-context.sh"
if [[ ! -x "$CONTEXT_SCRIPT" ]]; then
  exit 0
fi

# Get ticket context (full format for commit messages)
TICKET_CONTEXT=$("$CONTEXT_SCRIPT" full 2>/dev/null || echo "")

if [[ -z "$TICKET_CONTEXT" ]]; then
  exit 0
fi

# Check if the commit message already contains ticket info
if grep -q "^Ticket:" "$COMMIT_MSG_FILE" 2>/dev/null; then
  exit 0
fi

# Append ticket context to the commit message
# Add a separator and the ticket context at the end
{
  echo ""
  echo "---"
  echo ""
  echo "$TICKET_CONTEXT"
} >> "$COMMIT_MSG_FILE"

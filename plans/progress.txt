# Brain Dump - Progress Log

This file tracks what has been completed across Ralph iterations.
Claude Code / Ralph: APPEND new entries below - do not overwrite existing content.

Project: brain-dumpy
Spec: SPEC.md
PRD: plans/prd.json

---

## Iteration Log

### 2026-01-08 - BD-001
- Task: Project setup with TanStack Start
- Success: true
- Files: package.json, tsconfig.json, eslint.config.js, .prettierrc, src/routes/index.tsx, src/components/Header.tsx, src/app.test.ts
- Notes: Initialized TanStack Start with strict TypeScript, Tailwind, ESLint, Prettier, Vitest. Removed demo routes. All checks pass.

### 2026-01-08 - BD-002
- Task: SQLite database with Drizzle ORM
- Success: true
- Files: src/lib/schema.ts, src/lib/db.ts, src/lib/db.test.ts, drizzle.config.ts, drizzle/0000_nebulous_hemingway.sql, package.json
- Notes: Drizzle ORM with better-sqlite3. Schema for projects, epics, tickets with FK constraints and indexes. DB at ~/.brain-dump/brain-dump.db. 4 database tests pass.

### 2026-01-08 - BD-003
- Task: Basic CRUD API for projects
- Success: true
- Files: src/api/projects.ts, src/api/projects.test.ts
- Notes: TanStack Start server functions with inputValidator for validation. getProjects, getProject, createProject, updateProject, deleteProject. Path validation, error handling. 11 tests pass. All checks pass.

### 2026-01-08 - BD-004
- Task: Basic CRUD API for epics
- Success: true
- Files: src/api/epics.ts, src/api/epics.test.ts
- Notes: Server functions for getEpicsByProject, getEpic, createEpic, updateEpic, deleteEpic. Project validation, cascade delete handling. 14 tests pass. All checks pass.

### 2026-01-08 - BD-005
- Task: Basic CRUD API for tickets
- Success: true
- Files: src/api/tickets.ts, src/api/tickets.test.ts
- Notes: Server functions with filters (project, epic, status). Full CRUD plus updateTicketStatus and updateTicketPosition. Subtasks, blocking, tags support. completedAt auto-set. 20 tests pass. Total 50 tests.

### 2026-01-08 - BD-006
- Task: App layout with dark theme
- Success: true
- Files: src/components/AppLayout.tsx, src/routes/__root.tsx, src/routes/index.tsx
- Notes: Dark slate theme with persistent sidebar, header with search/view toggle/new ticket button. Kanban board placeholder with 5 columns. Removed old Header.tsx.

### 2026-01-08 - BD-007
- Task: Sidebar with project/epic tree
- Success: true
- Files: src/components/ProjectTree.tsx, src/components/AppLayout.tsx, src/lib/hooks.ts
- Notes: ProjectTree component with expandable projects showing epics. useProjects hook for data fetching. AppContext for global state (selectedProject, selectedEpic, viewMode). Visual indicators for selection. Add buttons on hover.

### 2026-01-08 - BD-008 & BD-009
- Task: List view and Kanban board view for tickets
- Success: true
- Files: src/components/TicketListView.tsx, src/routes/index.tsx, src/lib/hooks.ts
- Notes: TicketListView table with sorting by column (title, status, priority, date). Status and priority badges with color coding. Blocked indicator. KanbanBoard with 5 columns, ticket cards with tags/priority. useTickets hook with filters. View toggle functional.

### 2026-01-08 - BD-010
- Task: Drag and drop for Kanban
- Success: true
- Files: src/routes/index.tsx, package.json
- Notes: Added @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities. DndContext with PointerSensor and KeyboardSensor. SortableContext for columns. Drag overlay with visual feedback. Updates status and position on drop. Persists to database.

### 2026-01-08 - BD-011
- Task: View toggle (Kanban/List)
- Success: true
- Files: src/components/AppLayout.tsx
- Notes: Toggle buttons already in header from BD-006. Added localStorage persistence for view mode preference. Both views share same filtered data via useTickets hook.

### 2026-01-08 - BD-012
- Task: Ticket detail modal
- Success: true
- Files: src/components/TicketModal.tsx, src/routes/index.tsx
- Notes: Modal with all ticket fields, inline editing for title/description, dropdowns for status/priority/epic, tag editor, subtask list with checkboxes, blocked toggle with reason. Focus trap and Escape key for accessibility.

### 2026-01-08 - BD-013
- Task: Subtask management
- Success: true
- Files: src/components/TicketModal.tsx, src/routes/index.tsx, src/components/TicketListView.tsx
- Notes: Added up/down reorder buttons for subtasks. Subtask progress (e.g., 2/5) now shown on ticket cards in both Kanban and List views. All subtask CRUD operations save immediately.

### 2026-01-08 - BD-014
- Task: New ticket form
- Success: true
- Files: src/components/NewTicketModal.tsx, src/components/AppLayout.tsx, src/routes/index.tsx
- Notes: NewTicketModal component with title (required), description, priority, epic, and tags fields. Opens via New Ticket button in header. Project auto-selected from current filter. Status defaults to Backlog. Validation with error messages. ticketRefreshKey in context triggers refetch.

### 2026-01-08 - BD-015
- Task: Project and epic forms
- Success: true
- Files: src/components/ProjectModal.tsx, src/components/EpicModal.tsx, src/components/ProjectTree.tsx, src/components/AppLayout.tsx
- Notes: ProjectModal and EpicModal components for create/edit operations. Name, path (with existence validation), and color picker for projects. Title, description, and color for epics. Inline delete with confirmation dialog. Edit buttons appear on hover in ProjectTree sidebar. Context functions for modal management.

---

## VS Code Integration Epic Breakdown

### 2026-01-11 - Epic: Working with VS Code
- Agent: Breakdown (reviewing inception output)
- Epic ID: d7af1fab-599a-46f6-a4b1-bc15a29cfb3f
- Branch: feature/vscode-integration

**Tickets Created: 12**
- High Priority (5): BD-030, BD-032, BD-033, BD-034, BD-037
- Medium Priority (5): BD-031, BD-035, BD-036, BD-038, BD-039
- Low Priority (2): BD-040, BD-041

**Ticket Summary:**
| ID | Title | Priority |
|----|-------|----------|
| BD-030 | MCP Server VS Code Compatibility | High |
| BD-031 | Multi-Extension MCP Support | Medium |
| BD-032 | Environment Detection System | High |
| BD-033 | VS Code Custom Agent Files | High |
| BD-034 | Ralph Cross-Environment Support | High |
| BD-035 | Working Method Settings | Medium |
| BD-036 | Project Auto-Detection in VS Code | Medium |
| BD-037 | Ticket-to-Code Workflow | High |
| BD-038 | Code-to-Ticket Workflow | Medium |
| BD-039 | Agent-Driven Development Workflow | Medium |
| BD-040 | File/Folder Context Linking | Low |
| BD-041 | VS Code Setup Documentation | Medium |

**Implementation Order (Suggested):**
1. Phase 1 - Core: BD-030, BD-032, BD-035
2. Phase 2 - Agents: BD-033, BD-034
3. Phase 3 - Workflows: BD-036, BD-037, BD-038, BD-039
4. Phase 4 - Polish: BD-031, BD-040, BD-041

**Files Created:**
- plans/vscode-integration-spec.md (epic specification)
- Updated plans/prd.json (added BD-030 through BD-041)

**Notes:**
- Original 12 tickets superseded by atomic breakdown below

---

### 2026-01-11 - Atomic Ticket Breakdown

**Philosophy:** Each ticket = one focused session with fresh context. AI clears context between tickets for "fresh eyes" on each task.

**New Epics Created:**
1. MCP Server Enhancements (green) - 8 tickets
2. Cross-Environment Support (purple) - 7 tickets
3. VS Code Configuration (blue) - 9 tickets
4. Development Workflows (amber) - 4 tickets

**Total Atomic Tickets: 28**

**High Priority (13):**
- Verify MCP server works with Claude Code
- Test MCP server with VS Code native MCP
- Create .vscode/mcp.json template
- Create start_ticket_work MCP tool
- Create complete_ticket_work MCP tool
- Create environment detection utility
- Create get_environment MCP tool
- Add context reset signal on ticket completion
- Create breakdown.agent.md for VS Code
- Create inception.agent.md for VS Code
- Create ralph.agent.md for VS Code
- Define ticket-to-code workflow spec

**Key Feature: Context Reset**
When ticket completes, AI signals need for fresh context. Each ticket worked with clean slate = better quality.

**Implementation Order:**
1. Phase 1: Foundation (MCP baseline, env detection, config)
2. Phase 2: Core MCP Tools (workflow tools)
3. Phase 3: VS Code Agents (agent.md files)
4. Phase 4: Settings & Workflows
5. Phase 5: Review Pipeline
6. Phase 6: Polish & Testing

---

### 2026-01-11 - PRD Update: All Tickets Exported

**Task:** Update PRD with all 53 tickets from Brain Dumpy database

**Epics (6 total):**
1. working with vs code (original) - 12 tickets
2. MCP Server Enhancements - 8 tickets
3. Cross-Environment Support - 7 tickets
4. VS Code Configuration - 9 tickets
5. Development Workflows - 4 tickets
6. Review Pipeline - 12 tickets

**Tickets: 53 total**
- High Priority: 26 tickets
- Medium Priority: 22 tickets
- Low Priority: 5 tickets
- Completed: 1 (BD-001: Ghostty terminal fix)
- Backlog: 52

**Files Updated:**
- plans/prd.json (complete rewrite with all tickets)
- plans/vscode-integration-spec.md (added Review Pipeline epic)
- plans/progress.txt (this entry)

**PRD Structure:**
Each ticket now includes:
- id (BD-001 through BD-053)
- title
- description (full context)
- acceptance_criteria (parsed array)
- priority (high/medium/low)
- status (backlog/in_progress/done/etc)
- epic (which epic it belongs to)
- brain_dumpy_id (UUID from database)
- tags (array)
- passes (boolean, based on status)

**Ready for Ralph:**
Ralph can now pick up any ticket from BD-002 through BD-053 with full context from the PRD.

---

### 2026-01-11 - MCP Server Claude Code Verification
- Task: Verify MCP server works with Claude Code
- Ticket ID: 06633336-6d4e-49d7-a2a2-1a18b2eb6b81
- Success: true
- Agent: Ralph

**MCP Tools Verified (10 total):**

| Tool | Status | Description |
|------|--------|-------------|
| `list_projects` | ✅ | List all projects in Brain Dumpy |
| `find_project_by_path` | ✅ | Find project by filesystem path |
| `create_project` | ✅ | Create a new project |
| `create_ticket` | ✅ | Create a new ticket |
| `list_tickets` | ✅ | List tickets with filters |
| `update_ticket_status` | ✅ | Update ticket status |
| `list_epics` | ✅ | List epics for a project |
| `create_epic` | ✅ | Create a new epic |
| `add_ticket_comment` | ✅ | Add comment to a ticket |
| `get_ticket_comments` | ✅ | Get all comments for a ticket |

**Tools Actively Tested:**
- `list_projects` - Returned 5 projects
- `find_project_by_path` - Found Brain Dumpy project
- `list_epics` - Returned 5 epics for Brain Dumpy
- `list_tickets` - Returned tickets with filters
- `add_ticket_comment` - Added progress comment
- `get_ticket_comments` - Retrieved comments

**Observations:**
1. All tools callable from Claude Code via MCP integration
2. Tool names prefixed with `mcp__brain-dumpy__` in Claude Code
3. Parameters work as documented in schema
4. Error handling validates required fields and enum values
5. Database connection to `~/.brain-dump/brain-dump.db` works

**Limitations Identified:**
1. No `update_ticket` for general ticket updates
2. No `delete_ticket` or `delete_epic` tools
3. No `update_epic` tool
4. No `get_ticket` for single ticket by ID
5. Missing workflow tools documented in PRD tickets

**Files Modified:**
- plans/prd.json (marked ticket as passes: true)
- plans/progress.txt (this entry)

---

### 2026-01-11 - VS Code MCP Configuration Template
- Task: Create .vscode/mcp.json template
- Ticket ID: dc5b80d7-75c2-4e6e-b918-61f3b0dd8fdc
- Success: true
- Agent: Ralph

**Files Created:**
- `.vscode/mcp.json.example` - VS Code MCP configuration template

**Configuration Details:**
- Uses stdio transport (standard for MCP)
- Includes detailed JSONC comments explaining each field
- Points to `mcp-server/index.js` for the Brain Dumpy server
- Documents requirements (VS Code 1.99+, Node.js, database)

**Git Ignore Setup:**
- Updated `.gitignore` to track `.vscode/*.example` files
- Actual `mcp.json` remains ignored (user-specific paths)
- Users copy `.example` to `mcp.json` and update paths

**Usage Instructions (in file):**
1. Copy `.vscode/mcp.json.example` to `.vscode/mcp.json`
2. Update the path to match your Brain Dumpy installation
3. Restart VS Code or reload window

**Files Modified:**
- .gitignore (added exception for .example files)
- plans/prd.json (marked ticket as passes: true)
- plans/progress.txt (this entry)

---

### 2026-01-11 - start_ticket_work MCP Tool
- Task: Create start_ticket_work MCP tool
- Ticket ID: c9293544-5ab1-4fdc-9e7f-9b62907e7933
- Success: true
- Agent: Ralph

**Implementation:**
- Added `start_ticket_work` tool to MCP server
- Added `execSync` import from child_process
- Added git helper functions: `slugify`, `shortId`, `generateBranchName`, `runGitCommand`

**Tool Behavior:**
1. Takes `ticketId` as parameter
2. Validates ticket exists and gets project info
3. Checks if project path is a git repository
4. Generates branch name: `feature/{short-id}-{slug}`
   - short-id: first 8 chars of UUID
   - slug: lowercase, alphanumeric with hyphens, max 50 chars
5. Creates branch (or checks out if exists)
6. Updates ticket status to `in_progress`
7. Returns branch name, project info, and ticket details

**Error Handling:**
- Ticket not found
- Ticket already in progress (returns ticket info)
- Project path doesn't exist
- Not a git repository
- Git branch creation/checkout failures

**Files Modified:**
- mcp-server/index.js (added tool + helpers)
- plans/prd.json (marked ticket as passes: true)
- plans/progress.txt (this entry)

**Testing:**
- Syntax check: passed
- Type check: passed

---

### 2026-01-11 - complete_ticket_work MCP Tool
- Task: Create complete_ticket_work MCP tool
- Ticket ID: 44a97133-1e6e-40a4-af1c-ee4b85d843de
- Success: true
- Agent: Ralph

**Implementation:**
- Added `complete_ticket_work` tool to MCP server
- Reuses existing git helper functions

**Tool Behavior:**
1. Takes `ticketId` and optional `summary` as parameters
2. Validates ticket exists and is in completable state
3. Gets git commits on current branch (compared to main/master)
4. Generates suggested PR description from commits
5. Updates ticket status to `review`
6. Returns updated ticket, commits, and PR description

**PR Description Generation:**
- Detects base branch (main or master)
- Gets commits unique to feature branch
- Formats as markdown with summary, changes, and ticket info

**Error Handling:**
- Ticket not found
- Ticket already done (returns info)
- Ticket already in review (returns info)
- Gracefully handles non-git projects

**Files Modified:**
- mcp-server/index.js (added tool)
- plans/prd.json (marked ticket as passes: true)
- plans/progress.txt (this entry)

**Testing:**
- Syntax check: passed
- Type check: passed

---

### 2026-01-11 - link_commit_to_ticket MCP Tool
- Task: Create link_commit_to_ticket MCP tool
- Ticket ID: 04fd9275-46a2-42d2-82d3-de699e259962
- Success: true
- Agent: Ralph

**Implementation:**
- Added `link_commit_to_ticket` tool to MCP server
- Added database migration to create `linked_commits` column
- Stores commits as JSON array with hash, message, and timestamp

**Tool Behavior:**
1. Takes `ticketId`, `commitHash`, and optional `message` as parameters
2. Validates ticket exists
3. Auto-fetches commit message from git if not provided
4. Checks for duplicate commits (prevents re-linking)
5. Stores commit info in `linked_commits` JSON array
6. Returns all linked commits for the ticket

**Database Migration:**
- Automatically adds `linked_commits TEXT` column to tickets table
- Runs on MCP server startup if column doesn't exist
- Stores JSON array: `[{hash, message, linkedAt}, ...]`

**Error Handling:**
- Ticket not found
- Commit already linked (shows existing commits)
- Gracefully handles non-git projects

**Files Modified:**
- mcp-server/index.js (added tool + migration)
- plans/prd.json (marked ticket as passes: true)
- plans/progress.txt (this entry)

**Testing:**
- Syntax check: passed
- Type check: passed

---

### 2026-01-11 - link_files_to_ticket MCP Tool
- Task: Create link_files_to_ticket MCP tool
- Ticket ID: a3e3432e-836a-4fae-929a-0e22c3817af9
- Success: true
- Agent: Ralph

**Implementation:**
- Added `link_files_to_ticket` tool to MCP server
- Uses existing `linked_files` column in tickets table

**Tool Behavior:**
1. Takes `ticketId` and `files` array as parameters
2. Validates ticket exists and files array is valid
3. Normalizes paths (converts absolute to relative if within project)
4. Avoids duplicate file entries
5. Stores file paths in `linked_files` JSON array
6. Returns all linked files for the ticket

**Path Handling:**
- Accepts both relative and absolute paths
- Auto-converts absolute paths to relative (if within project)
- Prevents duplicate entries

**Error Handling:**
- Ticket not found
- Invalid files array (not array, empty)

**Files Modified:**
- mcp-server/index.js (added tool)
- plans/prd.json (marked ticket as passes: true)
- plans/progress.txt (this entry)

**Testing:**
- Syntax check: passed
- Type check: passed

---

### 2026-01-11 - get_tickets_for_file MCP Tool
- Task: Create get_tickets_for_file MCP tool
- Ticket ID: 4cdb7fc6-58ca-432e-9898-f56f30c2c5c4
- Success: true
- Agent: Ralph

**Implementation:**
- Added `get_tickets_for_file` tool to MCP server
- Searches tickets by linked file path

**Tool Behavior:**
1. Takes `filePath` and optional `projectId` as parameters
2. Normalizes search path (removes leading slash)
3. Queries all tickets with linked_files
4. Filters by partial path matching (bidirectional)
5. Returns formatted list of matching tickets

**Path Matching:**
- Supports partial path matching
- Matches if search path contains file OR file contains search path
- Example: "index.js" matches "src/index.js"

**Error Handling:**
- Missing filePath parameter
- No tickets found (with helpful tip)

**Files Modified:**
- mcp-server/index.js (added tool)
- plans/prd.json (marked ticket as passes: true)
- plans/progress.txt (this entry)

**Testing:**
- Syntax check: passed
- Type check: passed

---

### 2026-01-12 - XDG Directory Structure Utility
- Task: Create XDG-compliant directory structure utility
- Ticket ID: 74e5875f-ba81-40c3-9647-00ebeac2807c
- Success: true
- Agent: Ralph
- Branch: ralph/74e5875f-xdg-directory-utility

**Files Created:**
- `src/lib/xdg.ts` - XDG utility module
- `src/lib/xdg.test.ts` - Unit tests (18 tests)

**Functions Implemented:**
| Function | Description |
|----------|-------------|
| `getDataDir()` | Returns ~/.local/share/brain-dumpy/ |
| `getConfigDir()` | Returns ~/.config/brain-dumpy/ |
| `getCacheDir()` | Returns ~/.cache/brain-dumpy/ |
| `getStateDir()` | Returns ~/.local/state/brain-dumpy/ |
| `getLegacyDir()` | Returns ~/.brain-dump/ (for migration) |
| `getDatabasePath()` | Returns full database path |
| `getBackupsDir()` | Returns backups directory |
| `getLogsDir()` | Returns logs directory |
| `ensureDirectories()` | Creates all dirs with 0700 permissions |
| `ensureDirectoriesSync()` | Sync version for startup |

**Testing:**
- 18 unit tests all passing
- XDG module type-checks correctly
- Pre-existing type errors in index.tsx (separate ticket 2f780b3f created)

**Notes:**
- This utility is foundation for next tickets (database migration, backup system)

---

### 2026-01-12 - Migrate Database Location to XDG_DATA_HOME
- Task: Migrate database location to XDG_DATA_HOME
- Ticket ID: 53615062-25d0-4136-9a65-8442a7dde201
- Success: true
- Agent: Ralph
- Branch: ralph/74e5875f-xdg-directory-utility

**Files Modified:**
- `src/lib/db.ts` - Use XDG utilities for database path
- `cli/brain-dump.ts` - Use XDG paths for DB and state file
- `mcp-server/index.js` - Add XDG utilities with legacy fallback
- `src/lib/xdg.ts` - Fix require() to use static imports

**Changes:**
| Component | Old Path | New Path |
|-----------|----------|----------|
| Database | ~/.brain-dump/brain-dump.db | ~/.local/share/brain-dumpy/brain-dumpy.db |
| State file | ~/.brain-dump/current-ticket.json | ~/.local/state/brain-dumpy/current-ticket.json |

**MCP Server Backwards Compatibility:**
- Checks XDG path first: ~/.local/share/brain-dumpy/brain-dumpy.db
- Falls back to legacy: ~/.brain-dump/brain-dump.db
- Logs note about migration when using legacy path

**Testing:**
- All 68 tests passing
- CLI loads and works correctly
- MCP server syntax valid
- Type checks pass (except pre-existing index.tsx errors)

**Notes:**
- WAL and SHM files will be created alongside DB at new location
- Directories created with 0700 permissions for security
- Next ticket (e25afb2e) will handle automatic migration of existing data

---

### 2026-01-12 - Automatic Migration from Legacy Directory
- Task: Create automatic migration from legacy ~/.brain-dump directory
- Ticket ID: e25afb2e-9074-4c25-976e-554d906effdb
- Success: true
- Agent: Ralph
- Branch: ralph/74e5875f-xdg-directory-utility

**Files Created:**
- `src/lib/migration.ts` - Migration logic module
- `src/lib/migration.test.ts` - Unit tests (14 tests)

**Files Modified:**
- `src/lib/db.ts` - Integrated migration at app startup
- `mcp-server/index.js` - Added migration support with same logic

**Migration Features:**
| Feature | Implementation |
|---------|----------------|
| Pre-migration backup | SQLite VACUUM INTO to backups dir |
| Database copy | File copy with size verification |
| WAL/SHM handling | Copies journal files if present |
| Attachments | Copies entire attachments directory |
| Integrity check | PRAGMA integrity_check post-copy |
| Migration marker | .migrated JSON file in legacy dir |
| Logging | Logs to ~/.local/state/brain-dumpy/migration.log |

**Safety Measures:**
- Never deletes legacy data automatically
- Creates backup before any migration
- Verifies database integrity after copy
- Migration only runs once (marker file)
- Handles edge cases (both locations have data, etc.)

**Functions Implemented:**
```typescript
// Detection functions
hasLegacyData(): boolean
isMigrationComplete(): boolean
hasXdgData(): boolean
verifyDatabaseIntegrity(dbPath: string): boolean

// Migration functions
migrateFromLegacy(): Promise<MigrationResult>
migrateFromLegacySync(): MigrationResult
```

**Testing:**
- All 82 tests passing (14 new migration tests)
- MCP server syntax valid
- Type checks pass (except pre-existing index.tsx errors)

**Notes:**
- Migration runs automatically on first startup after upgrade
- Both main app and MCP server can trigger migration
- Legacy data preserved in ~/.brain-dump (not deleted)
- User informed via console logs


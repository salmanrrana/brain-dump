{
  "projectName": "Brain Dumpy",
  "projectPath": "/home/xtra/code/personal_projects/brain-dumpy",
  "userStories": [
    {
      "id": "74e5875f-ba81-40c3-9647-00ebeac2807c",
      "title": "Create XDG-compliant directory structure utility",
      "description": "## Task\nCreate utility module to determine and create XDG-compliant directory paths.\n\n## XDG Base Directories\n- `XDG_DATA_HOME`: `~/.local/share/brain-dumpy/` (database, exports)\n- `XDG_CONFIG_HOME`: `~/.config/brain-dumpy/` (settings)\n- `XDG_CACHE_HOME`: `~/.cache/brain-dumpy/` (temp files)\n- `XDG_STATE_HOME`: `~/.local/state/brain-dumpy/` (logs, backups)\n\n## Functions to Implement\n```typescript\nfunction getDataDir(): string\nfunction getConfigDir(): string\nfunction getCacheDir(): string\nfunction getStateDir(): string\nfunction ensureDirectories(): Promise<void>\n```\n\n## Acceptance Criteria\n- [ ] Respects XDG environment variables if set\n- [ ] Falls back to defaults if env vars not set\n- [ ] Creates directories with proper permissions (0700)\n- [ ] Unit tests for all functions\n\n## File to Create\n`src/lib/xdg.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "high",
      "tags": [
        "xdg",
        "utility",
        "foundation"
      ],
      "passes": true
    },
    {
      "id": "53615062-25d0-4136-9a65-8442a7dde201",
      "title": "Migrate database location to XDG_DATA_HOME",
      "description": "## Task\nMove SQLite database from `~/.brain-dump/` to `~/.local/share/brain-dumpy/`.\n\n## Changes Required\n- Update database path in schema.ts and connection setup\n- Use new XDG utility for path resolution\n- Ensure WAL and SHM files also go to correct location\n\n## New Path\n`~/.local/share/brain-dumpy/brain-dumpy.db`\n\n## Acceptance Criteria\n- [ ] New database location used for fresh installs\n- [ ] Database operations work at new location\n- [ ] WAL mode still works correctly\n- [ ] File permissions are secure (0600)\n\n## Files to Modify\n- `src/lib/schema.ts`\n- `cli/brain-dump.ts` (if hardcoded)\n- `mcp-server/index.js`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "high",
      "tags": [
        "xdg",
        "database",
        "migration"
      ],
      "passes": true
    },
    {
      "id": "e25afb2e-9074-4c25-976e-554d906effdb",
      "title": "Create automatic migration from legacy ~/.brain-dump directory",
      "description": "## Task\nImplement automatic one-time migration from old `~/.brain-dump/` to new XDG paths.\n\n## Migration Steps\n1. Check if legacy `~/.brain-dump/` exists\n2. Check if new XDG location already has data\n3. If legacy exists and XDG empty:\n   - Copy database to new location\n   - Copy attachments to new location\n   - Create `.migrated` marker in legacy dir\n   - Log migration success\n4. If both exist, warn user and use XDG\n\n## Safety Measures\n- Never delete legacy data automatically\n- Create backup before migration\n- Verify database integrity after copy\n- Atomic operations where possible\n\n## Acceptance Criteria\n- [ ] Migration runs automatically on first start\n- [ ] Legacy data preserved (not deleted)\n- [ ] Migration only happens once\n- [ ] Error handling for failed migrations\n- [ ] User informed of migration via log\n\n## File to Create\n`src/lib/migration.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "high",
      "tags": [
        "xdg",
        "migration",
        "safety"
      ],
      "passes": true
    },
    {
      "id": "0cd21f6e-3bc9-40e5-a2df-479f4d582b28",
      "title": "Implement automatic daily database backups",
      "description": "## Task\nAdd automatic daily backups of the SQLite database.\n\n## Backup Location\n`~/.local/state/brain-dumpy/backups/`\n\n## Backup Strategy\n- Create backup on first operation each day\n- Filename format: `brain-dumpy-YYYY-MM-DD.db`\n- Keep last 7 daily backups (configurable)\n- Use SQLite Online Backup API for consistency\n\n## Implementation\n```typescript\nasync function createBackupIfNeeded(): Promise<void>\nasync function cleanupOldBackups(keepDays: number): Promise<void>\n```\n\n## Acceptance Criteria\n- [ ] Backup created automatically daily\n- [ ] Backups are valid SQLite databases\n- [ ] Old backups cleaned up automatically\n- [ ] Backup doesn't block normal operations\n- [ ] Log backup success/failure\n\n## File to Create\n`src/lib/backup.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "high",
      "tags": [
        "backup",
        "database",
        "safety"
      ],
      "passes": true
    },
    {
      "id": "a7bbca6d-a9da-4733-bf62-41f1da610f64",
      "title": "Add manual backup/restore CLI commands",
      "description": "## Task\nAdd CLI commands for manual backup and restore operations.\n\n## Commands\n```bash\nbrain-dump backup              # Create immediate backup\nbrain-dump backup --list       # List available backups\nbrain-dump restore <filename>  # Restore from backup\nbrain-dump restore --latest    # Restore most recent backup\n```\n\n## Restore Safety\n- Require confirmation for restore\n- Create backup of current DB before restore\n- Verify backup integrity before restore\n- Show diff summary (ticket counts, etc.)\n\n## Acceptance Criteria\n- [ ] `backup` command creates timestamped backup\n- [ ] `backup --list` shows available backups with dates\n- [ ] `restore` command works with confirmation\n- [ ] Pre-restore backup created automatically\n- [ ] Clear success/error messages\n\n## File to Modify\n`cli/brain-dump.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "medium",
      "tags": [
        "cli",
        "backup",
        "restore"
      ],
      "passes": false
    },
    {
      "id": "254bca98-5777-43a5-acdc-1319181c2b19",
      "title": "Implement database lock file detection",
      "description": "## Task\nAdd lock file mechanism to detect and handle multiple processes accessing the database.\n\n## Lock File Location\n`~/.local/state/brain-dumpy/brain-dumpy.lock`\n\n## Lock File Contents\n```json\n{\n  \"pid\": 12345,\n  \"startedAt\": \"2026-01-12T00:00:00Z\",\n  \"type\": \"mcp-server\" | \"cli\" | \"vite\"\n}\n```\n\n## Behavior\n- Create lock on database open\n- Check if existing lock is stale (process not running)\n- Warn if another process has lock\n- Clean up lock on graceful shutdown\n- Handle SIGTERM/SIGINT for cleanup\n\n## Acceptance Criteria\n- [x] Lock file created on DB access\n- [x] Stale locks detected and cleaned\n- [x] Warning shown for concurrent access\n- [x] Lock cleaned up on shutdown\n- [x] Works across MCP server, CLI, and Vite\n\n## File to Create\n`src/lib/lockfile.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "high",
      "tags": [
        "database",
        "concurrency",
        "safety"
      ],
      "passes": true
    },
    {
      "id": "b892ddcc-b0d7-44ab-8239-a9f252af7c5a",
      "title": "Add file-based logging system",
      "description": "## Task\nImplement file-based logging for debugging and audit trail.\n\n## Log Location\n`~/.local/state/brain-dumpy/logs/`\n\n## Log Files\n- `brain-dumpy.log` - Main application log (rotated)\n- `mcp-server.log` - MCP server specific logs\n- `error.log` - Errors only (for quick debugging)\n\n## Log Format\n```\n2026-01-12T00:00:00.000Z [INFO] [mcp-server] Tool called: create_ticket\n2026-01-12T00:00:00.000Z [ERROR] [database] Failed to write: SQLITE_BUSY\n```\n\n## Features\n- Log levels: DEBUG, INFO, WARN, ERROR\n- Automatic rotation (keep 5 files, 10MB each)\n- Configurable log level via env var\n- Async file writes (non-blocking)\n\n## Acceptance Criteria\n- [ ] Logs written to XDG state directory\n- [ ] Log rotation working\n- [ ] All major operations logged\n- [ ] Errors include stack traces\n- [ ] LOG_LEVEL env var respected\n\n## File to Create\n`src/lib/logger.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "medium",
      "tags": [
        "logging",
        "debugging",
        "observability"
      ],
      "passes": false
    },
    {
      "id": "d87b3a30-04e9-4107-9be6-a06d9099f32b",
      "title": "Add database integrity check on startup",
      "description": "## Task\nRun SQLite integrity checks on startup to detect corruption early.\n\n## Checks to Perform\n1. `PRAGMA integrity_check` - Full database integrity\n2. `PRAGMA foreign_key_check` - Foreign key violations\n3. Verify WAL file consistency\n4. Check expected tables exist\n\n## Behavior\n- Run quick check on every startup\n- Full check weekly or on demand\n- Log results\n- Warn user if issues found\n- Offer to restore from backup if corrupted\n\n## Acceptance Criteria\n- [ ] Quick integrity check on startup\n- [ ] Full check available via CLI\n- [ ] Issues logged with details\n- [ ] Backup restore suggested if corrupted\n- [ ] Doesn't significantly slow startup\n\n## File to Create\n`src/lib/integrity.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "medium",
      "tags": [
        "database",
        "integrity",
        "safety"
      ],
      "passes": false
    },
    {
      "id": "e88860de-1309-4d67-8f61-80da55821dd2",
      "title": "Add MCP tool for database health status",
      "description": "## Task\nCreate MCP tool to report database health and backup status.\n\n## Tool: `get_database_health`\n\n## Returns\n```json\n{\n  \"status\": \"healthy\" | \"warning\" | \"error\",\n  \"databasePath\": \"~/.local/share/brain-dumpy/brain-dumpy.db\",\n  \"databaseSize\": \"15.2 MB\",\n  \"lastBackup\": \"2026-01-11T00:00:00Z\",\n  \"backupCount\": 7,\n  \"integrityCheck\": \"ok\",\n  \"activeConnections\": 2,\n  \"lockFile\": {\n    \"exists\": true,\n    \"pid\": 12345,\n    \"type\": \"mcp-server\"\n  },\n  \"issues\": []\n}\n```\n\n## Acceptance Criteria\n- [ ] Tool registered in MCP server\n- [ ] Returns accurate health info\n- [ ] Includes backup status\n- [ ] Shows lock file info\n- [ ] Lists any detected issues\n\n## File to Modify\n`mcp-server/index.js`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "low",
      "tags": [
        "mcp",
        "monitoring",
        "health"
      ],
      "passes": false
    },
    {
      "id": "e97a4485-af2a-4bd8-9763-20bb1a213a02",
      "title": "Add graceful shutdown handling for all processes",
      "description": "## Task\nEnsure all Brain Dumpy processes handle shutdown gracefully to prevent data loss.\n\n## Processes to Handle\n- MCP server\n- CLI commands\n- Vite dev server\n\n## Shutdown Actions\n1. Catch SIGTERM, SIGINT, SIGQUIT\n2. Flush any pending writes\n3. Run SQLite checkpoint (WAL mode)\n4. Remove lock file\n5. Close database connection\n6. Log shutdown\n\n## Implementation\n```typescript\nfunction setupGracefulShutdown(db: Database): void {\n  const cleanup = async () => {\n    await db.run('PRAGMA wal_checkpoint(TRUNCATE)');\n    await removeLockFile();\n    await db.close();\n    process.exit(0);\n  };\n  process.on('SIGTERM', cleanup);\n  process.on('SIGINT', cleanup);\n}\n```\n\n## Acceptance Criteria\n- [ ] All signals handled correctly\n- [ ] WAL checkpoint on shutdown\n- [ ] Lock file cleaned up\n- [ ] No data loss on Ctrl+C\n- [ ] Works for all process types\n\n## Files to Modify\n- `mcp-server/index.js`\n- `cli/brain-dump.ts`\n- `vite.config.ts` (dev server)",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "high",
      "tags": [
        "shutdown",
        "database",
        "safety"
      ],
      "passes": false
    },
    {
      "id": "f8ab8cff-ec40-49e0-a784-c5020b764cf0",
      "title": "Update documentation for new data locations",
      "description": "## Task\nUpdate all documentation to reflect new XDG-compliant data locations.\n\n## Documentation Updates\n\n### README.md\n- Update data location section\n- Add migration notes for existing users\n- Document backup/restore commands\n\n### New Docs\n- `docs/data-locations.md` - All paths explained\n- `docs/backup-restore.md` - Backup system guide\n- `docs/troubleshooting.md` - Common issues\n\n## Content to Include\n- XDG directory explanation\n- Environment variable overrides\n- Backup schedule and retention\n- How to recover from corruption\n- Migration from legacy paths\n\n## Acceptance Criteria\n- [ ] README updated with new paths\n- [ ] Migration guide for existing users\n- [ ] Backup/restore documented\n- [ ] Troubleshooting guide created\n\n## Files to Modify\n- `README.md`\n- `docs/*.md` (new files)",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "low",
      "tags": [
        "documentation",
        "xdg"
      ],
      "passes": false
    },
    {
      "id": "e5aebb29-3760-403c-8978-a975f2f448e8",
      "title": "Add database file watcher for deletion detection",
      "description": "## Task\nImplement file system watcher to detect if database files are unexpectedly deleted while in use.\n\n## Context\nThis ticket was created after a mysterious database deletion incident where the .db files were deleted while processes held open file handles.\n\n## Implementation\n- Watch database directory for deletion events\n- Detect if .db, .db-wal, or .db-shm files are deleted\n- If deletion detected while DB open:\n  - Log critical error immediately\n  - Attempt emergency backup from memory\n  - Alert user via MCP response or CLI output\n  - Prevent further writes to avoid data loss\n\n## Technical Approach\n```typescript\nimport { watch } from 'fs';\n\nfunction watchDatabaseFiles(dbPath: string) {\n  const watcher = watch(dirname(dbPath), (event, filename) => {\n    if (filename?.endsWith('.db') && event === 'rename') {\n      // File might be deleted - check if it exists\n      if (!existsSync(dbPath)) {\n        handleDatabaseDeletion();\n      }\n    }\n  });\n}\n```\n\n## Acceptance Criteria\n- [ ] Watcher detects .db file deletion\n- [ ] Critical error logged immediately\n- [ ] Emergency backup attempted\n- [ ] User alerted via available channel\n- [ ] Further writes prevented\n\n## File to Create\n`src/lib/db-watcher.ts`",
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "priority": "high",
      "tags": [
        "database",
        "safety",
        "monitoring",
        "incident-response"
      ],
      "passes": false
    }
  ],
  "generatedAt": "2026-01-12T00:35:35.062Z",
  "epicTitle": "XDG Migration & Data Protection"
}
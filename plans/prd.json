{
  "projectName": "Brain Dump",
  "projectPath": "/Users/salman.rana/code/brain-dump",
  "testingRequirements": [
    "Tests must validate user-facing behavior, not implementation details",
    "Focus on what users actually do - integration tests over unit tests",
    "Don't mock excessively - test real behavior where possible",
    "Coverage metrics are meaningless - user flow coverage is everything"
  ],
  "userStories": [
    {
      "id": "bf82d056-4e08-4ed2-802a-d4563b02fe2f",
      "title": "Create Docker Runtime Detection Module",
      "passes": true,
      "overview": "Create `src/lib/docker-runtime.ts` module that provides cross-platform Docker runtime detection with **Lima-first strategy** on macOS.",
      "types": [
        {
          "name": "DockerRuntimeInfo",
          "code": "interface DockerRuntimeInfo {\n  type: DockerRuntimeType;\n  socketPath: string;\n  available: boolean;\n  version?: string;\n}"
        },
        {
          "name": "DockerRuntimeType",
          "code": "type DockerRuntimeType = 'lima' | 'colima' | 'rancher' | 'docker-desktop' | 'podman' | 'unknown';"
        }
      ],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Lima checked first on macOS (darwin platform)",
        "All socket paths validated with `fs.existsSync()` before returning",
        "Falls back to `DOCKER_HOST` env var if set",
        "Cross-platform support: macOS, Linux, Windows",
        "Caches detection result for session (avoid repeated filesystem checks)"
      ],
      "references": [
        "src/lib/docker-runtime.ts",
        "src/api/terminal-utils.ts"
      ],
      "description": "## Overview\nCreate `src/lib/docker-runtime.ts` module that provides cross-platform Docker runtime detection with **Lima-first strategy** on macOS.\n\n## Detection Priority Order\n1. User-configured socket path (from settings)\n2. `DOCKER_HOST` environment variable\n3. **Lima** (macOS): `~/.lima/docker/sock/docker.sock` or `~/.lima/default/sock/docker.sock`\n4. **Colima** (macOS): `~/.colima/default/docker.sock`\n5. **Rancher Desktop**: `~/.rd/docker.sock`\n6. **Docker Desktop**: `/var/run/docker.sock` (macOS/Linux) or named pipe (Windows)\n7. **Podman**: `/run/user/$UID/podman/podman.sock`\n\n## Interface\n```typescript\ntype DockerRuntimeType = 'lima' | 'colima' | 'rancher' | 'docker-desktop' | 'podman' | 'unknown';\n\ninterface DockerRuntimeInfo {\n  type: DockerRuntimeType;\n  socketPath: string;\n  available: boolean;\n  version?: string;\n}\n```\n\n## Exports\n- `detectDockerRuntime(): Promise<DockerRuntimeInfo>`\n- `getDockerSocketPath(): Promise<string | null>`\n- `isDockerRuntimeAvailable(type: DockerRuntimeType): Promise<boolean>`\n- `getAllAvailableRuntimes(): Promise<DockerRuntimeInfo[]>`\n\n## Acceptance Criteria\n- [ ] Lima checked first on macOS (darwin platform)\n- [ ] All socket paths validated with `fs.existsSync()` before returning\n- [ ] Falls back to `DOCKER_HOST` env var if set\n- [ ] Cross-platform support: macOS, Linux, Windows\n- [ ] Caches detection result for session (avoid repeated filesystem checks)\n\n## Files\n- `src/lib/docker-runtime.ts` (NEW)\n\n## Pattern Reference\nFollow `src/api/terminal-utils.ts` structure for ordered detection",
      "priority": "high",
      "tags": [
        "backend",
        "docker",
        "foundation"
      ]
    },
    {
      "id": "c5250732-c0c7-4fd1-a869-52e1e369ef07",
      "title": "Add Docker Runtime Config to Schema",
      "passes": true,
      "overview": "Extend database schema and settings system to persist Docker runtime configuration.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Migration created via `pnpm db:generate`",
        "Migration applies cleanly via `pnpm db:migrate`",
        "`getSettings()` returns new fields (defaults: null = auto-detect)",
        "`updateSettings()` accepts and persists new fields",
        "Backward compatible: existing settings still work"
      ],
      "references": [
        "src/lib/schema.ts",
        "src/api/settings.ts",
        "src/lib/hooks.ts"
      ],
      "description": "## Overview\nExtend database schema and settings system to persist Docker runtime configuration.\n\n## Schema Changes (`src/lib/schema.ts`)\nAdd to `settings` table:\n```typescript\ndockerRuntime: text(\"docker_runtime\"), // 'auto' | 'lima' | 'colima' | 'docker-desktop' | 'podman'\ndockerSocketPath: text(\"docker_socket_path\"), // Custom socket path override (nullable)\n```\n\n## API Changes (`src/api/settings.ts`)\n- Update `UpdateSettingsInput` interface to include new fields\n- Update `updateSettings()` handler to persist new fields\n- Add validation: `dockerRuntime` must be valid runtime or null\n\n## Type Updates (`src/lib/hooks.ts`)\n- Update `Settings` interface with new fields\n\n## Acceptance Criteria\n- [ ] Migration created via `pnpm db:generate`\n- [ ] Migration applies cleanly via `pnpm db:migrate`\n- [ ] `getSettings()` returns new fields (defaults: null = auto-detect)\n- [ ] `updateSettings()` accepts and persists new fields\n- [ ] Backward compatible: existing settings still work\n\n## Depends On\n- Create Docker Runtime Detection Module\n\n## Files\n- `src/lib/schema.ts`\n- `src/api/settings.ts`\n- `src/lib/hooks.ts`\n- `drizzle/migrations/` (auto-generated)",
      "priority": "high",
      "tags": [
        "backend",
        "database",
        "schema"
      ]
    },
    {
      "id": "316e34ea-67ed-4858-b2d5-31f1e4f06d5e",
      "title": "Update Docker Commands to Use Detected Socket",
      "passes": true,
      "overview": "Update all Docker command executions to use the detected or configured socket path via `DOCKER_HOST` environment variable.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "All `execAsync(\"docker ...\")` calls use `getDockerCommand()` helper",
        "Helper reads settings first, falls back to auto-detect",
        "Docker commands work with Lima socket path",
        "Docker commands work with default socket path",
        "Ralph script includes correct Docker flags for non-default sockets"
      ],
      "references": [
        "src/api/ralph.ts",
        "src/api/settings.ts"
      ],
      "description": "## Overview\nUpdate all Docker command executions to use the detected or configured socket path via `DOCKER_HOST` environment variable.\n\n## Helper Function\nCreate `getDockerCommand()` helper that:\n1. Checks settings for user-configured runtime\n2. Falls back to auto-detection if not configured\n3. Returns appropriate command prefix: `DOCKER_HOST=unix:///path/to/socket docker` or just `docker`\n\n## Functions to Update (`src/api/ralph.ts`)\n- `getDockerStatus()` \n- `validateDockerSetup()`\n- `ensureDockerNetwork()`\n- `buildSandboxImage()`\n- `isContainerRunning()`\n- `startCompanionContainer()`\n- `stopCompanionContainer()`\n- `getRunningCompanionContainers()`\n\n## Functions to Update (`src/api/settings.ts`)\n- `getDockerStatus()`\n- `buildSandboxImage()`\n\n## Ralph Script Generation\nUpdate `generateRalphScript()` to include `-H` flag or set `DOCKER_HOST` env var when using non-default socket.\n\n## Acceptance Criteria\n- [ ] All `execAsync(\"docker ...\")` calls use `getDockerCommand()` helper\n- [ ] Helper reads settings first, falls back to auto-detect\n- [ ] Docker commands work with Lima socket path\n- [ ] Docker commands work with default socket path\n- [ ] Ralph script includes correct Docker flags for non-default sockets\n\n## Depends On\n- Add Docker Runtime Config to Schema\n\n## Files\n- `src/api/ralph.ts`\n- `src/api/settings.ts`",
      "priority": "high",
      "tags": [
        "backend",
        "docker",
        "core"
      ]
    },
    {
      "id": "bcdf2f06-9f99-4d7a-a48d-f299f8e5e4b0",
      "title": "Create Docker Runtime Query Hooks",
      "passes": true,
      "overview": "Create TanStack Query hooks for fetching Docker runtime information, used by Settings UI.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "`useAvailableDockerRuntimes()` returns list of detected runtimes",
        "`useActiveDockerRuntime()` returns current active runtime",
        "Active runtime respects user preference over auto-detect",
        "Hooks use appropriate `staleTime` (30s)",
        "Error handling for detection failures"
      ],
      "references": [
        "src/api/settings.ts",
        "src/lib/hooks.ts"
      ],
      "description": "## Overview\nCreate TanStack Query hooks for fetching Docker runtime information, used by Settings UI.\n\n## New Server Functions (`src/api/settings.ts`)\n```typescript\n// Returns all detected runtimes with availability status\nexport const detectDockerRuntimes = createServerFn({ method: \"GET\" })\n  .handler(async () => { ... });\n\n// Returns the active runtime (user-configured or auto-detected)\nexport const getActiveDockerRuntime = createServerFn({ method: \"GET\" })\n  .handler(async () => { ... });\n```\n\n## New Hooks (`src/lib/hooks.ts`)\n```typescript\n// Returns all available runtimes for dropdown\nexport function useAvailableDockerRuntimes() {\n  return useQuery({\n    queryKey: [\"dockerRuntimes\"],\n    queryFn: () => detectDockerRuntimes(),\n    staleTime: 30_000, // 30 seconds\n  });\n}\n\n// Returns the currently active runtime\nexport function useActiveDockerRuntime() {\n  return useQuery({\n    queryKey: [\"activeDockerRuntime\"],\n    queryFn: () => getActiveDockerRuntime(),\n    staleTime: 30_000,\n  });\n}\n```\n\n## Query Keys\nAdd to `queryKeys` object:\n- `dockerRuntimes: [\"dockerRuntimes\"]`\n- `activeDockerRuntime: [\"activeDockerRuntime\"]`\n\n## Acceptance Criteria\n- [ ] `useAvailableDockerRuntimes()` returns list of detected runtimes\n- [ ] `useActiveDockerRuntime()` returns current active runtime\n- [ ] Active runtime respects user preference over auto-detect\n- [ ] Hooks use appropriate `staleTime` (30s)\n- [ ] Error handling for detection failures\n\n## Depends On\n- Create Docker Runtime Detection Module\n\n## Files\n- `src/api/settings.ts`\n- `src/lib/hooks.ts`",
      "priority": "medium",
      "tags": [
        "backend",
        "hooks",
        "api"
      ]
    },
    {
      "id": "2fb5d889-5ef0-40a6-88e2-b7f8a5fba603",
      "title": "Add Docker Runtime Selection to Settings Modal",
      "passes": false,
      "overview": "Add \"Docker Runtime\" section to Settings Modal within the Ralph (Autonomous Mode) section.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Dropdown appears in Ralph section below Docker Sandbox toggle",
        "All runtime options selectable",
        "Auto-detect shows detected runtime with green checkmark",
        "Manual selection persists on save",
        "Selecting unavailable runtime shows warning but allows save",
        "Status indicator updates dynamically"
      ],
      "references": [
        "src/components/SettingsModal.tsx"
      ],
      "description": "## Overview\nAdd \"Docker Runtime\" section to Settings Modal within the Ralph (Autonomous Mode) section.\n\n## Location\n`src/components/SettingsModal.tsx` - Below \"Docker Sandbox\" toggle (around line 308)\n\n## UI Specification\n```\nDocker Runtime\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[Dropdown: Auto-detect (recommended) | Docker Desktop | Lima | Colima | Podman]\n\nDetected: Lima (docker VM)\nSocket: ~/.lima/docker/sock/docker.sock\nStatus: ðŸŸ¢ Connected\n```\n\n## Dropdown Options\n- \"Auto-detect (recommended)\" - default, null value\n- \"Docker Desktop\"\n- \"Lima\"\n- \"Colima\"  \n- \"Podman\"\n\n## States\n- **Loading**: \"Detecting runtime...\" while hooks load\n- **Detected**: Green CheckCircle + runtime name\n- **Manual Override**: Show configured value + info tooltip\n- **Error**: Yellow AlertTriangle + \"Runtime not found\"\n\n## Acceptance Criteria\n- [ ] Dropdown appears in Ralph section below Docker Sandbox toggle\n- [ ] All runtime options selectable\n- [ ] Auto-detect shows detected runtime with green checkmark\n- [ ] Manual selection persists on save\n- [ ] Selecting unavailable runtime shows warning but allows save\n- [ ] Status indicator updates dynamically\n\n## Pattern References\n- Terminal dropdown: SettingsModal.tsx lines 227-253\n- Docker status: SettingsModal.tsx lines 309-401\n\n## Accessibility\n- Dropdown has associated label via htmlFor/id\n- Status uses aria-live=\"polite\" for updates\n- Error states use role=\"alert\"\n\n## Files\n- `src/components/SettingsModal.tsx`",
      "priority": "high",
      "tags": [
        "frontend",
        "ui",
        "settings"
      ]
    },
    {
      "id": "16d24387-1008-4c2f-8f2e-916745391bda",
      "title": "Create Container Status Sidebar Section",
      "passes": false,
      "overview": "Create collapsible sidebar section showing running companion containers with real-time status.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Section appears between Tags and Sample Data banner",
        "Collapsible with smooth animation",
        "Running count in header when collapsed",
        "Each container shows name, status, port, connection string",
        "Copy button with visual feedback (check icon)",
        "Updates via 5s polling",
        "Hidden when no containers configured"
      ],
      "references": [
        "src/components/AppLayout.tsx"
      ],
      "description": "## Overview\nCreate collapsible sidebar section showing running companion containers with real-time status.\n\n## Location\n`src/components/AppLayout.tsx` - Sidebar function, between Tags section and Sample Data Banner (around line 830)\n\n## UI Specification\n### Collapsed State\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CONTAINERS              2 â–¼     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Expanded State\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CONTAINERS              2 â–²     â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ ðŸŸ¢ postgres              :8400  â”‚\nâ”‚    postgresql://...        [ðŸ“‹] â”‚\nâ”‚ ðŸŸ¢ redis                 :8401  â”‚\nâ”‚    redis://...             [ðŸ“‹] â”‚\nâ”‚ â—‹ mysql                         â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Status Indicators\n- ðŸŸ¢ Green pulse: Running\n- â—‹ Gray: Stopped/not started\n- ðŸŸ¡ Amber: Starting/stopping\n\n## States\n- **Loading**: Skeleton loader (pulsing gray rectangles)\n- **Empty**: Section hidden or shows \"No containers\"\n- **Error**: Inline error with AlertTriangle\n- **Running**: Full list with status\n\n## Hooks to Use\n- `useRunningCompanionContainers()` - polls every 5s\n- `useCompanionContainerInfo()` - static config\n\n## Acceptance Criteria\n- [ ] Section appears between Tags and Sample Data banner\n- [ ] Collapsible with smooth animation\n- [ ] Running count in header when collapsed\n- [ ] Each container shows name, status, port, connection string\n- [ ] Copy button with visual feedback (check icon)\n- [ ] Updates via 5s polling\n- [ ] Hidden when no containers configured\n\n## Pattern References\n- Collapsible: ProjectTree.tsx lines 39-53\n- Section header: AppLayout.tsx lines 816-830  \n- Copy button: EpicModal.tsx lines 518-529\n\n## Accessibility\n- aria-expanded on toggle button\n- Semantic list with role=\"list\"\n- Copy announces \"Copied\" via aria-live\n\n## Files\n- `src/components/AppLayout.tsx` (or new `ContainerStatusSection.tsx`)",
      "priority": "high",
      "tags": [
        "frontend",
        "ui",
        "sidebar"
      ]
    },
    {
      "id": "25a30799-fab2-4da1-976f-55841e450195",
      "title": "Add Container Start/Stop Actions to Sidebar",
      "passes": false,
      "overview": "Add inline start/stop action buttons for each container in the Container Status sidebar section.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Each row has appropriate start or stop button",
        "Start button triggers `startCompanionContainers` mutation",
        "Stop button triggers `stopCompanionContainers` mutation",
        "Loading spinner during operation",
        "Button disabled during loading",
        "Error shows toast notification",
        "Success updates container list immediately",
        "Only affects single container"
      ],
      "references": [
        "src/components/AppLayout.tsx"
      ],
      "description": "## Overview\nAdd inline start/stop action buttons for each container in the Container Status sidebar section.\n\n## UI Specification\nEach container row has action buttons:\n- **Running**: Red Stop button (Square icon)\n- **Stopped**: Green Start button (Play icon)\n- **Loading**: Spinner replaces action button\n\n```\nâ”‚ ðŸŸ¢ postgres  [â– ] [ðŸ“‹]  â”‚  â† Stop + Copy\nâ”‚ â—‹ redis      [â–¶] [ðŸ“‹]  â”‚  â† Start + Copy\n```\n\n## States\n- **Idle running**: Stop button visible (red Square icon)\n- **Idle stopped**: Start button visible (green Play icon)\n- **Starting**: Loader2 spinner, button disabled\n- **Stopping**: Loader2 spinner, button disabled\n- **Error**: Toast with error message\n\n## Mutations to Use\n- `useStartCompanionContainers({ services: [service] })`\n- `useStopCompanionContainers({ services: [service] })`\n\n## Acceptance Criteria\n- [ ] Each row has appropriate start or stop button\n- [ ] Start button triggers `startCompanionContainers` mutation\n- [ ] Stop button triggers `stopCompanionContainers` mutation\n- [ ] Loading spinner during operation\n- [ ] Button disabled during loading\n- [ ] Error shows toast notification\n- [ ] Success updates container list immediately\n- [ ] Only affects single container\n\n## Depends On\n- Create Container Status Sidebar Section\n\n## Pattern References\n- Action buttons: ProjectTree.tsx lines 202-225\n- Loading states: EpicModal.tsx lines 407-412\n\n## Accessibility\n- Buttons have aria-label (\"Start postgres\", \"Stop redis\")\n- Loading state has aria-busy=\"true\"\n\n## Files\n- `src/components/AppLayout.tsx` or `ContainerStatusSection.tsx`",
      "priority": "medium",
      "tags": [
        "frontend",
        "ui",
        "actions"
      ]
    },
    {
      "id": "03f58ab0-c918-4e40-9c03-d538a9a12810",
      "title": "Add Stop All Containers Quick Action",
      "passes": false,
      "overview": "Add \"Stop All\" button to Container Status sidebar header for bulk container shutdown.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Button only visible when â‰¥1 container running",
        "Click shows inline confirmation",
        "Confirmation has Yes/No buttons",
        "Loading prevents double-clicks",
        "Success shows toast with count",
        "Container list updates after stop",
        "Escape cancels confirmation"
      ],
      "references": [
        "src/components/AppLayout.tsx"
      ],
      "description": "## Overview\nAdd \"Stop All\" button to Container Status sidebar header for bulk container shutdown.\n\n## Location\nRight side of \"CONTAINERS\" section header, next to collapse toggle.\n\n## UI Specification\n```\nâ”‚ CONTAINERS    [Stop All] 2 â–¼ â”‚\n```\n\n- Button: Small text \"Stop All\" in red-400\n- Only visible when containers running\n- Hover: bg-red-900/50\n\n## Confirmation Flow\n1. Click \"Stop All\"\n2. Inline confirmation: \"Stop all?\" [Yes] [No]\n3. Loading: \"Stopping...\" disabled\n4. Success: Toast \"Stopped X container(s)\"\n\n## States\n- **Hidden**: No containers running\n- **Default**: \"Stop All\" text button\n- **Confirming**: Yes/No inline buttons\n- **Loading**: \"Stopping...\" disabled\n- **Success**: Toast notification\n\n## Acceptance Criteria\n- [ ] Button only visible when â‰¥1 container running\n- [ ] Click shows inline confirmation\n- [ ] Confirmation has Yes/No buttons\n- [ ] Loading prevents double-clicks\n- [ ] Success shows toast with count\n- [ ] Container list updates after stop\n- [ ] Escape cancels confirmation\n\n## Depends On\n- Create Container Status Sidebar Section\n\n## Pattern References\n- Delete confirmation: EpicModal.tsx lines 260-281\n- Toast: useToast from Toast.tsx\n\n## Accessibility\n- aria-label=\"Stop all running containers\"\n- Escape key cancels\n- Announce \"Confirmation required\" to screen readers\n\n## Files\n- `src/components/AppLayout.tsx` or `ContainerStatusSection.tsx`",
      "priority": "medium",
      "tags": [
        "frontend",
        "ui",
        "actions"
      ]
    },
    {
      "id": "1b5e2e24-1f3e-4392-94a4-b41e8c749cd4",
      "title": "Create Docker Runtime Detection Unit Tests",
      "passes": false,
      "overview": "Create comprehensive unit tests for the Docker runtime detection module.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Test file `src/lib/docker-runtime.test.ts` created",
        "Tests for `detectDockerRuntime()` on each platform",
        "Tests for `getDockerSocketPath()` for each runtime",
        "Tests for `DOCKER_HOST` override",
        "Tests for fallback behavior",
        "Tests pass: `pnpm test src/lib/docker-runtime.test.ts`",
        "Good coverage of happy paths and error cases"
      ],
      "references": [
        "src/lib/docker-runtime.test.ts",
        "src/lib/terminal-utils.test.ts"
      ],
      "description": "## Overview\nCreate comprehensive unit tests for the Docker runtime detection module.\n\n## Test Categories\n\n### 1. Detection Order Tests\n- Verify Lima checked first on macOS (darwin)\n- Verify native Docker checked first on Linux\n- Verify Docker Desktop on Windows\n\n### 2. Socket Validation Tests\n- Mock filesystem to test socket existence checks\n- Test with valid socket paths\n- Test with missing sockets\n\n### 3. Platform-Specific Tests\n- Mock `process.platform` for each OS\n- Test macOS, Linux, Windows code paths\n\n### 4. Environment Variable Tests\n- Test `DOCKER_HOST` override behavior\n- Verify env var takes precedence\n\n### 5. Error Handling Tests\n- Test when no runtime available\n- Test when socket exists but not accessible\n\n## Acceptance Criteria\n- [ ] Test file `src/lib/docker-runtime.test.ts` created\n- [ ] Tests for `detectDockerRuntime()` on each platform\n- [ ] Tests for `getDockerSocketPath()` for each runtime\n- [ ] Tests for `DOCKER_HOST` override\n- [ ] Tests for fallback behavior\n- [ ] Tests pass: `pnpm test src/lib/docker-runtime.test.ts`\n- [ ] Good coverage of happy paths and error cases\n\n## Depends On\n- Create Docker Runtime Detection Module\n\n## Pattern Reference\nFollow `src/lib/terminal-utils.test.ts` patterns\n\n## Files\n- `src/lib/docker-runtime.test.ts` (NEW)",
      "priority": "medium",
      "tags": [
        "testing",
        "backend"
      ]
    },
    {
      "id": "40818428-b62f-48a0-930d-dae76c3bf072",
      "title": "Add Runtime Detection Integration Tests",
      "passes": false,
      "overview": "Create integration tests verifying Docker runtime detection works end-to-end with actual Docker operations.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Integration test file created",
        "Tests skipped when Docker not available",
        "Test: Detect runtime returns valid runtime",
        "Test: `docker info` succeeds with detected socket",
        "Test: Network operations work",
        "Test: Settings round-trip for runtime config",
        "Tests pass locally with Docker",
        "Tests skip gracefully in CI"
      ],
      "references": [
        "src/api/docker-integration.test.ts"
      ],
      "description": "## Overview\nCreate integration tests verifying Docker runtime detection works end-to-end with actual Docker operations.\n\n## Test Scenarios\n1. Detect runtime and verify socket accessible\n2. Run `docker info` with detected socket\n3. Test Docker network creation with detected socket\n4. Test Docker image inspection\n5. Settings persistence round-trip\n\n## Skip Behavior\nTests should use `describe.skipIf()` pattern to skip when Docker unavailable:\n```typescript\ndescribe.skipIf(!hasDocker)('Docker integration', () => {\n  // tests\n});\n```\n\n## Acceptance Criteria\n- [ ] Integration test file created\n- [ ] Tests skipped when Docker not available\n- [ ] Test: Detect runtime returns valid runtime\n- [ ] Test: `docker info` succeeds with detected socket\n- [ ] Test: Network operations work\n- [ ] Test: Settings round-trip for runtime config\n- [ ] Tests pass locally with Docker\n- [ ] Tests skip gracefully in CI\n\n## Depends On\n- Update Docker Commands to Use Detected Socket\n\n## Files\n- `src/api/docker-integration.test.ts` (NEW)",
      "priority": "low",
      "tags": [
        "testing",
        "integration"
      ]
    },
    {
      "id": "870e199a-bc38-40ba-b931-1fe0868d8f64",
      "title": "Add Runtime Status to Ralph Launch Panel",
      "passes": false,
      "overview": "Add small runtime indicator to EpicModal Ralph panel showing which Docker runtime will be used.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Indicator only appears when sandbox enabled",
        "Shows detected or configured runtime",
        "Warning if Docker unavailable",
        "Links to settings if not configured",
        "Uses `settings.ralphSandbox` for visibility"
      ],
      "references": [
        "src/components/EpicModal.tsx"
      ],
      "description": "## Overview\nAdd small runtime indicator to EpicModal Ralph panel showing which Docker runtime will be used.\n\n## Location\nTop of Ralph Configuration Panel in EpicModal, below header.\n\n## UI Specification\n```\nRalph Configuration\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[ðŸ³] Using Lima (docker VM)    â† NEW indicator\n\nDocker Sandbox: [âœ“]\n...\n```\n\n- Only visible when sandbox mode enabled\n- Small text (text-xs), slate-400 color\n- Warning if Docker not available\n\n## States\n- **Sandbox disabled**: Hidden\n- **Detected**: \"Using [runtime name]\"\n- **Not detected**: Warning \"No Docker runtime detected\"\n\n## Acceptance Criteria\n- [ ] Indicator only appears when sandbox enabled\n- [ ] Shows detected or configured runtime\n- [ ] Warning if Docker unavailable\n- [ ] Links to settings if not configured\n- [ ] Uses `settings.ralphSandbox` for visibility\n\n## Depends On\n- Add Docker Runtime Selection to Settings Modal\n\n## Pattern References\n- Docker status: SettingsModal.tsx lines 309-340\n- Info text: EpicModal.tsx line 485\n\n## Files\n- `src/components/EpicModal.tsx`",
      "priority": "low",
      "tags": [
        "frontend",
        "ui",
        "polish"
      ]
    },
    {
      "id": "6328ea7e-47f8-4082-964c-841e5c81abbf",
      "title": "Track Project Origin for Containers",
      "passes": false,
      "overview": "Track which project/epic launched each companion container so the UI can display \"Started by: Project Name (Epic)\".",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Containers launched with project/epic labels",
        "`getRunningCompanionContainers()` returns project info",
        "Sidebar shows which project started each container",
        "Handles containers started before this feature (show \"Unknown\")",
        "Labels persist across container restarts"
      ],
      "references": [
        "src/api/ralph.ts",
        "src/components/AppLayout.tsx"
      ],
      "description": "## Overview\nTrack which project/epic launched each companion container so the UI can display \"Started by: Project Name (Epic)\".\n\n## Implementation Approach\n\n### Option A: Docker Labels (Recommended)\nWhen starting containers, add labels:\n```bash\ndocker run --label brain-dump.project-id=xxx \\\n           --label brain-dump.epic-id=yyy \\\n           --label brain-dump.project-name=\"My App\" \\\n           ...\n```\n\nThen query with:\n```bash\ndocker inspect --format '{{index .Config.Labels \"brain-dump.project-name\"}}' ralph-postgres\n```\n\n### Option B: Database Tracking Table\nAdd `container_sessions` table:\n```typescript\ncontainerSessions = sqliteTable(\"container_sessions\", {\n  id: text(\"id\").primaryKey(),\n  containerName: text(\"container_name\").notNull(),\n  projectId: text(\"project_id\").references(() => projects.id),\n  epicId: text(\"epic_id\").references(() => epics.id),\n  startedAt: text(\"started_at\").notNull(),\n  stoppedAt: text(\"stopped_at\"),\n});\n```\n\n## Changes Required\n\n### Update `startCompanionContainer()` in `src/api/ralph.ts`\n- Accept `projectId` and `epicId` parameters\n- Add Docker labels to container run command\n- (If Option B) Insert record into tracking table\n\n### Update `getRunningCompanionContainers()` \n- Query Docker labels to get project info\n- Return project name alongside container info\n\n### Update UI Display\n- Show \"Started by: [Project] ([Epic])\" in container sidebar\n- Style as muted text below container name\n\n## Acceptance Criteria\n- [ ] Containers launched with project/epic labels\n- [ ] `getRunningCompanionContainers()` returns project info\n- [ ] Sidebar shows which project started each container\n- [ ] Handles containers started before this feature (show \"Unknown\")\n- [ ] Labels persist across container restarts\n\n## Depends On\n- Create Container Status Sidebar Section\n\n## Files\n- `src/api/ralph.ts` - Add labels to container launch\n- `src/components/AppLayout.tsx` - Display project origin in sidebar",
      "priority": "medium",
      "tags": [
        "backend",
        "frontend",
        "tracking"
      ]
    },
    {
      "id": "df385a2b-09b8-41e9-9e12-cc82342b4023",
      "title": "Add Container Logs Viewer",
      "passes": false,
      "overview": "Add ability to view container logs from the sidebar. Can either open in system terminal or show inline in a modal.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Logs button visible on each container row",
        "Click opens terminal with docker logs command",
        "Uses correct Docker socket from runtime detection",
        "Works with Lima/Colima/Docker Desktop"
      ],
      "references": [
        "src/components/AppLayout.tsx",
        "src/api/ralph.ts"
      ],
      "description": "## Overview\nAdd ability to view container logs from the sidebar. Can either open in system terminal or show inline in a modal.\n\n## Options\n\n### Option A: Open in Terminal (Simpler)\n- Click \"Logs\" button on container row\n- Opens system terminal with `docker logs -f ralph-postgres`\n- Uses existing terminal launcher from Ralph\n\n### Option B: Inline Modal (Richer)\n- Click \"Logs\" opens modal with scrolling log output\n- Stream logs via WebSocket or polling\n- Follow/pause toggle\n- Search within logs\n- Copy all logs button\n\n## UI Specification\n\n### Sidebar Button\n```\nâ”‚ ðŸŸ¢ postgres  [ðŸ“‹] [ðŸ“„] [â– ] â”‚\n                 â”‚    â”‚    â””â”€â”€ Stop\n                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€ Logs\n                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Copy\n```\n\n### Terminal Approach\n- Reuse `openTerminalWithCommand()` from terminal launching\n- Command: `docker logs -f --tail 100 ralph-postgres`\n\n### Modal Approach (if chosen)\n- Similar to existing modal patterns\n- Monospace font for logs\n- Auto-scroll with \"Follow\" toggle\n- Last 500 lines shown by default\n\n## Acceptance Criteria\n- [ ] Logs button visible on each container row\n- [ ] Click opens terminal with docker logs command\n- [ ] Uses correct Docker socket from runtime detection\n- [ ] Works with Lima/Colima/Docker Desktop\n\n## Depends On\n- Create Container Status Sidebar Section\n- Update Docker Commands to Use Detected Socket\n\n## Files\n- `src/components/AppLayout.tsx` or `ContainerStatusSection.tsx`\n- `src/api/ralph.ts` - Add logs helper function",
      "priority": "medium",
      "tags": [
        "frontend",
        "ui",
        "logs"
      ]
    },
    {
      "id": "fc6f8adc-088c-4158-a07b-e1abf8e1b1b2",
      "title": "Add Container Resource Usage Display",
      "passes": false,
      "overview": "Show CPU and memory usage for each running container in the sidebar.",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "CPU percentage displayed per container",
        "Memory usage displayed (used / limit)",
        "Updates every 10 seconds when visible",
        "Graceful handling when stats unavailable",
        "Uses correct Docker socket"
      ],
      "references": [
        "src/api/ralph.ts",
        "src/lib/hooks.ts",
        "src/components/AppLayout.tsx"
      ],
      "description": "## Overview\nShow CPU and memory usage for each running container in the sidebar.\n\n## Data Source\nUse `docker stats --no-stream` command:\n```bash\ndocker stats --no-stream --format \"{{.Name}}\\t{{.CPUPerc}}\\t{{.MemUsage}}\" ralph-postgres\n```\n\nOutput: `ralph-postgres    0.15%    24.5MiB / 7.75GiB`\n\n## UI Specification\n\n### Compact View (in sidebar)\n```\nâ”‚ ðŸŸ¢ postgres              :8400  â”‚\nâ”‚    CPU: 0.2%  RAM: 24MB   [ðŸ“‹] â”‚\n```\n\n### Expanded View (hover or click)\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ postgres                       â”‚\nâ”‚ â”â”â”â”â”â”â”â”â–‘â–‘â–‘â–‘ 0.2% CPU         â”‚\nâ”‚ â”â”â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 24/7680 MB RAM   â”‚\nâ”‚ Up 2 hours                     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Polling Strategy\n- Poll `docker stats` every 10 seconds (heavier than ps)\n- Only when sidebar section is expanded\n- Cache results for 10s\n\n## New Hook\n```typescript\nexport function useContainerStats() {\n  return useQuery({\n    queryKey: [\"containerStats\"],\n    queryFn: () => getContainerStats(),\n    refetchInterval: 10_000, // 10 seconds\n    enabled: isContainerSectionExpanded,\n  });\n}\n```\n\n## Acceptance Criteria\n- [ ] CPU percentage displayed per container\n- [ ] Memory usage displayed (used / limit)\n- [ ] Updates every 10 seconds when visible\n- [ ] Graceful handling when stats unavailable\n- [ ] Uses correct Docker socket\n\n## Depends On\n- Create Container Status Sidebar Section\n- Update Docker Commands to Use Detected Socket\n\n## Files\n- `src/api/ralph.ts` - Add `getContainerStats()` server function\n- `src/lib/hooks.ts` - Add `useContainerStats()` hook\n- `src/components/AppLayout.tsx` - Display stats in container rows",
      "priority": "low",
      "tags": [
        "frontend",
        "backend",
        "monitoring"
      ]
    }
  ],
  "projectContext": {
    "techStack": [
      "Framework: TanStack Start (React 19 + Vite + Nitro)",
      "Database: SQLite with better-sqlite3, Drizzle ORM",
      "Styling: Tailwind CSS v4",
      "State: TanStack Query for server state",
      "Drag & Drop: @dnd-kit"
    ],
    "dosDonts": [
      {
        "category": "Database Queries",
        "dos": [
          "Use Drizzle ORM: `db.select().from(tickets)`",
          "Use typed schema imports: `import { tickets } from \"../lib/schema\"`",
          "Use `eq()`, `and()`, `sql` from drizzle-orm for conditions",
          "Use transactions for multi-table operations: `db.transaction(() => {...})`",
          "Use `.get()` for single row, `.all()` for multiple"
        ],
        "donts": [
          "Raw SQL strings: `db.run(\"SELECT * FROM tickets\")`",
          "String-based table names",
          "String concatenation for WHERE clauses",
          "Multiple independent queries that should be atomic",
          "Assume query returns what you expect without checking"
        ]
      },
      {
        "category": "React & TanStack Query",
        "dos": [
          "Use `useQuery` with `queryKeys` for data fetching",
          "Use `useMutation` with `onSuccess` for state changes",
          "Invalidate queries after mutations: `queryClient.invalidateQueries({ queryKey: queryKeys.tickets })`",
          "Use centralized `queryKeys` object from `src/lib/hooks.ts`",
          "Create custom hooks in `src/lib/hooks.ts` for reusable query logic"
        ],
        "donts": [
          "`useState` + `useEffect` for fetched data",
          "Direct API calls without proper cache invalidation",
          "Manual cache manipulation or refetch after every change",
          "Hardcoded query key strings throughout components",
          "Duplicate query setup in multiple components"
        ]
      },
      {
        "category": "Server Functions",
        "dos": [
          "Use `createServerFn({ method: \"GET\" })` for reads, `\"POST\"` for writes",
          "Use `.inputValidator()` for type-safe input handling",
          "Return typed data directly: `return db.select().from(tickets).all()`",
          "Use `ensureExists()` for required lookups: `ensureExists(project, \"Project\")`",
          "Import from `@tanstack/react-start` (not `@tanstack/react-start/server`)"
        ],
        "donts": [
          "Mix GET/POST inconsistently",
          "Access raw input without validation",
          "Wrap in unnecessary response objects",
          "Return null and let caller handle missing data",
          "Wrong import path"
        ]
      },
      {
        "category": "MCP Tool Implementation",
        "dos": [
          "Use Zod schemas for input validation: `{ ticketId: z.string() }`",
          "Return structured `{ content: [{ type: \"text\", text: ... }] }` format",
          "Set `isError: true` for error responses",
          "Use `log.info()` / `log.error()` from `../lib/logging.js`",
          "Include helpful error messages: `\"Project not found. Use list_projects to see available.\"`"
        ],
        "donts": [
          "Trust input without validation",
          "Return plain strings",
          "Return error text without the error flag",
          "`console.log` in MCP server code",
          "Generic \"Not found\" errors"
        ]
      },
      {
        "category": "Testing Patterns (Kent C. Dodds)",
        "dos": [
          "Test user behavior: what users see, click, and experience",
          "Integration tests for workflows: test components together",
          "Real database fixtures with actual schema",
          "Tests that fail when user-facing behavior breaks",
          "Ask: \"Does this test catch bugs users would encounter?\""
        ],
        "donts": [
          "Test implementation details, internal state, or private methods",
          "Unit tests for every function",
          "Excessive mocking of internals",
          "Tests that break on refactoring internals",
          "Chase 100% code coverage as a goal"
        ]
      }
    ],
    "verificationSteps": [
      "Run `pnpm type-check` - must pass with no errors",
      "Run `pnpm lint` - must pass with no errors",
      "Run `pnpm test` - all tests must pass",
      "Added tests for new functionality (following Kent C. Dodds testing philosophy)",
      "Used typed error classes (not generic `Error`)",
      "Used Drizzle ORM (not raw SQL) - see DO/DON'T table above",
      "Followed existing patterns from DO/DON'T tables",
      "No hardcoded values that should be configurable",
      "Existing tests still pass",
      "No regressions in related functionality",
      "Updated tests if behavior changed",
      "Did not break backward compatibility (unless explicitly requested)",
      "Manually verified in browser at `localhost:4242`",
      "Checked responsive layout",
      "Verified TanStack Query invalidates and updates correctly",
      "Accessibility: keyboard navigation works, proper ARIA labels",
      "Migration file created via `pnpm db:generate`",
      "Migration tested with `pnpm db:migrate`",
      "Backup tested if schema changed (use `pnpm brain-dump backup` then test restore)",
      "Updated `src/lib/schema.ts` with proper types and constraints",
      "Tested tool via Claude Code integration",
      "Verified error responses are informative (see DO/DON'T table)",
      "Updated tool documentation if interface changed",
      "Added Zod schema for input validation",
      "All acceptance criteria from ticket met",
      "Work summary added via `add_ticket_comment` (for Ralph sessions)",
      "Session completed with appropriate outcome (for Ralph sessions)",
      "Committed with proper message format: `feat(<ticket-id>): <description>`"
    ]
  },
  "generatedAt": "2026-01-17T11:42:51.141Z",
  "epicTitle": "Docker Container Status & Runtime Detection",
  "epicDescription": "Add persistent visibility of running Docker containers to Brain Dump's UI, with Lima-first runtime detection for users without Docker Desktop.\n\n**Goals:**\n- Show running containers in sidebar (always visible, not hidden in modals)\n- Auto-detect Lima/Colima/Podman runtimes\n- Let users configure runtime in Settings\n- Provide actionable error messages for common issues\n\n**User Stories:**\n- As a Lima user, I want Brain Dump to auto-detect my Docker socket so containers work without manual config\n- As a developer, I want to see running containers at a glance so I know what services are available\n- As a user, I want to copy connection strings quickly so I can use them in my code"
}

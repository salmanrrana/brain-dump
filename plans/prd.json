{
  "projectName": "Brain Dump",
  "projectPath": "/home/xtra/code/personal_projects/brain-dump",
  "testingRequirements": [
    "Tests must validate user-facing behavior, not implementation details",
    "Focus on what users actually do - integration tests over unit tests",
    "Don't mock excessively - test real behavior where possible",
    "Coverage metrics are meaningless - user flow coverage is everything"
  ],
  "userStories": [
    {
      "id": "6de39d35-b1bf-4cee-919c-f6adf267d6fe",
      "title": "Phase 1: Foundation - Types, Errors & jszip Dependency",
      "passes": false,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "`jszip` added to package.json dependencies",
        "`core/transfer-types.ts` created with all interfaces",
        "Error classes added to `core/errors.ts`",
        "`core/index.ts` updated with exports",
        "`pnpm type-check` passes"
      ],
      "references": [],
      "description": "## Reference\nSee full plan in overview ticket: `c884a905-6009-406e-a14d-0783bc078586`\n\n## Branch & PR\nThis ticket shares a branch and PR with all other tickets in this epic. Use `workflow start-epic` on the epic to create the shared branch before starting work.\n\n## Scope\n\n### 1.1 Add jszip dependency\n```bash\npnpm add jszip\n```\n- Single dependency handles both zip read and write\n- Ships with TypeScript types built-in\n\n### 1.2 Create `core/transfer-types.ts`\nAll manifest interfaces:\n- `BrainDumpManifest` - top-level manifest structure (version, exportType, exportedAt, exportedBy, appVersion, sourceProject, etc.)\n- `ExportedEpic` - epic metadata (title, description, color, position)\n- `ExportedTicket` - full ticket detail, tags parsed, git/PR fields stripped\n- `ExportedComment` - ticket comments\n- `ExportedReviewFinding` - review findings\n- `ExportedDemoScript` - demo scripts with steps\n- `ExportedWorkflowState` - ticket workflow state\n- `ExportedEpicWorkflowState` - epic workflow state (learnings)\n- `ExportedAttachmentFile` - attachment metadata (archivePath, originalTicketId, filename)\n\nParam/result types:\n- `ExportResult` - manifest + attachment buffers map\n- `ImportParams` - filePath, targetProjectId, resetStatuses, conflictResolution\n- `ImportResult` - counts, id map, warnings\n- `ConflictResolution` - `\"create-new\" | \"replace\" | \"merge\"`\n\n### 1.3 Add error classes to `core/errors.ts`\n- `TransferError` (base for export/import errors)\n- `InvalidArchiveError` (corrupt zip, bad manifest version)\n- `ArchiveTooLargeError` (exceeds 100MB limit)\n\n### 1.4 Update `core/index.ts`\n- Export all new types and functions from transfer modules\n\n## Acceptance Criteria\n- [ ] `jszip` added to package.json dependencies\n- [ ] `core/transfer-types.ts` created with all interfaces\n- [ ] Error classes added to `core/errors.ts`\n- [ ] `core/index.ts` updated with exports\n- [ ] `pnpm type-check` passes",
      "priority": "high",
      "tags": [
        "phase-1",
        "foundation"
      ]
    },
    {
      "id": "a7e383a8-0f17-4459-b0db-6686c16d00a5",
      "title": "Phase 2: Core Export & Import Logic",
      "passes": false,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "`gatherEpicExportData` gathers all related data for an epic",
        "`gatherProjectExportData` gathers all epics + orphan tickets",
        "Exported data strips git/PR fields and excludes telemetry/sessions",
        "`importData` creates fresh UUIDs and remaps all foreign keys",
        "`importData` adds `shared-by:{username}` tag to every imported ticket",
        "`importData` adds provenance comment to every imported ticket",
        "All three conflict resolution modes work (create-new, replace, merge)",
        "Position calculation avoids conflicts with existing tickets",
        "100MB size limit enforced on export",
        "Missing attachments produce warnings, not failures",
        "Zip round-trip preserves manifest and attachment integrity",
        "`pnpm type-check` passes"
      ],
      "references": [],
      "description": "## Reference\nSee full plan in overview ticket: `c884a905-6009-406e-a14d-0783bc078586`\n\n## Branch & PR\nThis ticket shares a branch and PR with all other tickets in this epic.\n\n## Scope\n\n### 2.1 Create `core/transfer.ts` - Pure export/import business logic\n\n**Export functions** (no zip dependency - works with manifest + buffer map):\n\n`gatherEpicExportData(db, { epicId })` → `ExportResult`\n- Query epic + project for metadata\n- Query all tickets for the epic\n- For each ticket: query comments, review findings, demo scripts, workflow state\n- Query epic workflow state (learnings)\n- Read attachment files from disk into buffers\n- Strip git/PR fields, parse JSON columns, auto-detect username\n- Check total size against 100MB limit\n\n`gatherProjectExportData(db, { projectId })` → `ExportResult`\n- Same as above but for ALL epics + orphan tickets in the project\n\n**Import function:**\n\n`importData(db, params: ImportParams)` → `ImportResult`\n- Generate fresh UUIDs, build old→new ID map\n- Detect epic name conflicts, apply `conflictResolution` strategy\n- In a single transaction:\n  - Insert epics (mapped to target project)\n  - Insert tickets (remap epicId, append `shared-by:{username}` tag, clear git fields, recalculate positions)\n  - Insert comments (remap ticketId) + add provenance comment per ticket\n  - Insert review findings (remap ticketId)\n  - Insert demo scripts (remap ticketId)\n  - Insert workflow states (remap ticketId/epicId)\n- Extract attachment files to `{attachmentsDir}/{newTicketId}/{filename}`\n- Return counts + id map + warnings\n\n**Reuse existing functions:**\n- `core/db.ts` → `getDataDir()` for attachment paths\n- `core/json.ts` → `safeJsonParse()` for JSON column handling\n- `core/git-utils.ts` → `slugify()` for filename generation\n\n### 2.2 Create `core/transfer-zip.ts` - Thin zip adapter\n\n- `createBrainDumpArchive(data: ExportResult)` → `Promise<Buffer>`\n- `extractBrainDumpArchive(zipBuffer: Buffer)` → `Promise<{ manifest, attachmentBuffers }>`\n- `previewBrainDumpArchive(zipBuffer: Buffer)` → `Promise<ManifestPreview>` (reads only manifest.json, skips attachments)\n\n## Acceptance Criteria\n- [ ] `gatherEpicExportData` gathers all related data for an epic\n- [ ] `gatherProjectExportData` gathers all epics + orphan tickets\n- [ ] Exported data strips git/PR fields and excludes telemetry/sessions\n- [ ] `importData` creates fresh UUIDs and remaps all foreign keys\n- [ ] `importData` adds `shared-by:{username}` tag to every imported ticket\n- [ ] `importData` adds provenance comment to every imported ticket\n- [ ] All three conflict resolution modes work (create-new, replace, merge)\n- [ ] Position calculation avoids conflicts with existing tickets\n- [ ] 100MB size limit enforced on export\n- [ ] Missing attachments produce warnings, not failures\n- [ ] Zip round-trip preserves manifest and attachment integrity\n- [ ] `pnpm type-check` passes",
      "priority": "high",
      "tags": [
        "phase-2",
        "core"
      ]
    },
    {
      "id": "938f6875-1aef-4a88-a9eb-9bf635360988",
      "title": "Phase 4: CLI Transfer Commands",
      "passes": false,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "`pnpm brain-dump transfer export-epic --epic <id>` writes .braindump file",
        "`pnpm brain-dump transfer export-project --project <id>` writes .braindump file",
        "`pnpm brain-dump transfer import --file <path> --target-project <id>` imports data",
        "`--pretty` flag produces human-readable output",
        "`--reset-statuses` flag resets all imported ticket statuses to backlog",
        "`--conflict` flag supports all three resolution modes",
        "Backward-compat shortcuts (`brain-dump export`, `brain-dump import`) work",
        "`pnpm type-check` passes"
      ],
      "references": [],
      "description": "## Reference\nSee full plan in overview ticket: `c884a905-6009-406e-a14d-0783bc078586`\n\n## Branch & PR\nThis ticket shares a branch and PR with all other tickets in this epic.\n\n## Scope\n\n### 4.1 Create `cli/commands/transfer.ts`\n\nActions: `export-epic`, `export-project`, `import`\n\nFlags:\n- `--epic <id>` / `--project <id>` / `--target-project <id>`\n- `--file <path>` (for import)\n- `--output <path>` (for export)\n- `--reset-statuses` (import: reset all to backlog)\n- `--conflict <create-new|replace|merge>` (import: how to handle existing epics)\n- `--pretty` (human-readable output)\n\nUses `runAsync` since jszip operations are async.\n\n### 4.2 Update `cli/brain-dump.ts`\n- Add `import * as transfer from \"./commands/transfer.ts\"`\n- Add `\"transfer\"` to `RESOURCES` array\n- Add `case \"transfer\": runAsync(transfer.handle, action, rest)` to switch\n- Add backward-compat shortcuts: `brain-dump export` and `brain-dump import`\n\n## Acceptance Criteria\n- [ ] `pnpm brain-dump transfer export-epic --epic <id>` writes .braindump file\n- [ ] `pnpm brain-dump transfer export-project --project <id>` writes .braindump file\n- [ ] `pnpm brain-dump transfer import --file <path> --target-project <id>` imports data\n- [ ] `--pretty` flag produces human-readable output\n- [ ] `--reset-statuses` flag resets all imported ticket statuses to backlog\n- [ ] `--conflict` flag supports all three resolution modes\n- [ ] Backward-compat shortcuts (`brain-dump export`, `brain-dump import`) work\n- [ ] `pnpm type-check` passes",
      "priority": "medium",
      "tags": [
        "phase-4",
        "cli"
      ]
    },
    {
      "id": "be53f60b-fc07-4d82-b7f1-bfc60f8329de",
      "title": "Phase 5: Server Functions & React Query Hooks",
      "passes": false,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "4 server functions created and properly typed",
        "Server functions use base64 encoding for zip data transfer",
        "React Query mutations handle loading/error/success states",
        "`useExportEpic` triggers browser download on success",
        "`usePerformImport` invalidates relevant query caches on success",
        "Browser download utility works for base64-encoded zip files",
        "Transfer hooks re-exported from `src/lib/hooks/index.ts`",
        "`pnpm type-check` passes"
      ],
      "references": [
        "src/api/transfer.ts",
        "src/lib/db.ts",
        "src/lib/hooks/transfer.ts",
        "src/lib/download.ts",
        "src/lib/hooks/index.ts"
      ],
      "description": "## Reference\nSee full plan in overview ticket: `c884a905-6009-406e-a14d-0783bc078586`\n\n## Branch & PR\nThis ticket shares a branch and PR with all other tickets in this epic.\n\n## Scope\n\n### 5.1 Create `src/api/transfer.ts` - TanStack Start server functions\n\n4 server functions:\n- `exportEpic(epicId)` → `{ filename, data: base64, manifest summary }`\n- `exportProject(projectId)` → same shape\n- `previewImport(base64Data)` → manifest preview (epic names, counts, exporter info)\n- `performImport({ fileData, targetProjectId, resetStatuses, conflictResolution })` → `ImportResult`\n\nThe UI uses base64 encoding to transfer zip data between browser and server. Server functions pass `sqlite` (raw better-sqlite3 instance from `src/lib/db.ts`) to core functions.\n\n### 5.2 Create `src/lib/hooks/transfer.ts` - React Query mutations\n\n- `useExportEpic()` - mutation, triggers browser download on success\n- `useExportProject()` - mutation, triggers browser download on success\n- `usePreviewImport()` - mutation, returns manifest preview for UI\n- `usePerformImport()` - mutation, invalidates `queryKeys.allTickets`, `queryKeys.projects`, `queryKeys.allTags` on success\n\n### 5.3 Create `src/lib/download.ts` - Browser download utility\n\n- `downloadBase64File(base64Data, filename, mimeType)` - creates Blob, triggers `<a>` click download\n\n### 5.4 Update `src/lib/hooks/index.ts`\n- Add transfer hooks section with re-exports\n\n## Acceptance Criteria\n- [ ] 4 server functions created and properly typed\n- [ ] Server functions use base64 encoding for zip data transfer\n- [ ] React Query mutations handle loading/error/success states\n- [ ] `useExportEpic` triggers browser download on success\n- [ ] `usePerformImport` invalidates relevant query caches on success\n- [ ] Browser download utility works for base64-encoded zip files\n- [ ] Transfer hooks re-exported from `src/lib/hooks/index.ts`\n- [ ] `pnpm type-check` passes",
      "priority": "medium",
      "tags": [
        "phase-5",
        "frontend",
        "api"
      ]
    },
    {
      "id": "f4df95f6-9d43-4d54-bcb7-74e99c0e98b4",
      "title": "Phase 6: UI - Export & Import Modals",
      "passes": false,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "ExportModal shows summary and triggers download",
        "ImportModal has 3-step wizard flow (file select → preview → result)",
        "Drag-and-drop file selection works",
        "Manifest preview displays all counts correctly",
        "Conflict resolution UI shown only when epic name conflicts exist",
        "\"Export\" option added to EpicModal action dropdown",
        "\"Import\" button added to sidebar navigation",
        "Project-level export accessible from project context",
        "Loading/error states handled in both modals",
        "`pnpm type-check` and `pnpm lint` pass"
      ],
      "references": [
        "src/components/transfer/ExportModal.tsx",
        "src/components/transfer/ImportModal.tsx",
        "src/components/EpicModal.tsx"
      ],
      "description": "## Reference\nSee full plan in overview ticket: `c884a905-6009-406e-a14d-0783bc078586`\n\n## Branch & PR\nThis ticket shares a branch and PR with all other tickets in this epic.\n\n## Scope\n\n### 6.1 Create `src/components/transfer/ExportModal.tsx`\n\nSimple confirmation modal shown when user clicks export:\n- Shows what will be exported (epic name, ticket count, attachment count)\n- Loading state while generating\n- Triggers browser download on success\n- Toast notification\n\n### 6.2 Create `src/components/transfer/ImportModal.tsx`\n\nMulti-step wizard modal:\n\n**Step 1 - File Selection:**\n- Drag-and-drop zone or file picker button\n- Accept only `.braindump` files\n- Read file, call `previewImport` to parse manifest\n\n**Step 2 - Preview & Options:**\n- Show: exporter name, source project, epic names, ticket/comment/finding/attachment counts\n- Project picker dropdown (required - which project to import into)\n- \"Reset all statuses to backlog\" toggle (default: off)\n- Conflict resolution radio (shown only if epic name conflict detected):\n  - \"Create as new epic\" (default, safe)\n  - \"Replace existing epic\" (with confirmation warning)\n  - \"Merge into existing epic\"\n\n**Step 3 - Result:**\n- Success: \"Imported X tickets into Y project\" with counts breakdown\n- Navigate to project or close\n\n### 6.3 Update `src/components/EpicModal.tsx`\n- Add \"Export\" option to the existing action dropdown menu (alongside Ralph launch options)\n- Opens ExportModal with the epic's ID\n\n### 6.4 Add Import button to sidebar/navigation\n- Add an \"Import\" button near the project list area\n- Uses Upload icon from lucide-react\n- Opens ImportModal\n\n### 6.5 Add Project-level export\n- Add \"Export Project\" to project context menu or ProjectModal\n- Opens ExportModal in project mode\n\n## Acceptance Criteria\n- [ ] ExportModal shows summary and triggers download\n- [ ] ImportModal has 3-step wizard flow (file select → preview → result)\n- [ ] Drag-and-drop file selection works\n- [ ] Manifest preview displays all counts correctly\n- [ ] Conflict resolution UI shown only when epic name conflicts exist\n- [ ] \"Export\" option added to EpicModal action dropdown\n- [ ] \"Import\" button added to sidebar navigation\n- [ ] Project-level export accessible from project context\n- [ ] Loading/error states handled in both modals\n- [ ] `pnpm type-check` and `pnpm lint` pass",
      "priority": "medium",
      "tags": [
        "phase-6",
        "frontend",
        "ui"
      ]
    },
    {
      "id": "b7b0d4ec-5f43-4219-bf0f-e6171625875c",
      "title": "Phase 7: Tests - Core Logic & Zip Round-trip",
      "passes": false,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "All core export tests pass",
        "All core import tests pass (including all 3 conflict resolution modes)",
        "Zip round-trip tests pass",
        "Edge case tests pass (empty epic, missing attachments, size limit)",
        "`pnpm test` passes with all new tests",
        "`pnpm check` passes (type-check + lint + all tests)"
      ],
      "references": [],
      "description": "## Reference\nSee full plan in overview ticket: `c884a905-6009-406e-a14d-0783bc078586`\n\n## Branch & PR\nThis ticket shares a branch and PR with all other tickets in this epic.\n\n## Scope\n\n### 7.1 Create `core/__tests__/transfer.test.ts` - Core logic tests\n\nUsing `createTestDatabase()` from `core/db.ts`:\n\n- Export epic with tickets, comments, findings, demos → verify manifest structure\n- Export project with multiple epics + orphan tickets\n- Import into fresh project → verify all entities created with new IDs\n- Import with `resetStatuses: true` → verify all tickets in backlog\n- Import adds `shared-by:{username}` tag to every ticket\n- Import adds provenance comment to every ticket\n- Re-import with `conflictResolution: \"create-new\"` → creates separate epic\n- Re-import with `conflictResolution: \"replace\"` → old tickets removed, new inserted\n- Re-import with `conflictResolution: \"merge\"` → matching tickets updated, new added\n- Exported data excludes telemetry/sessions/conversation logs\n- Exported data excludes git/PR fields\n- Position calculation doesn't conflict with existing tickets\n- Archive size limit enforcement (>100MB rejected)\n- Missing attachment on disk → warning, not failure\n\n### 7.2 Create `core/__tests__/transfer-zip.test.ts` - Zip round-trip tests\n\n- Create export data → zip → extract → verify manifest matches\n- Attachments survive round-trip (binary integrity)\n- Invalid/corrupt zip rejected with clear error\n- Invalid manifest version rejected\n- Preview reads only manifest (fast, skips attachments)\n\n## Acceptance Criteria\n- [ ] All core export tests pass\n- [ ] All core import tests pass (including all 3 conflict resolution modes)\n- [ ] Zip round-trip tests pass\n- [ ] Edge case tests pass (empty epic, missing attachments, size limit)\n- [ ] `pnpm test` passes with all new tests\n- [ ] `pnpm check` passes (type-check + lint + all tests)",
      "priority": "medium",
      "tags": [
        "phase-7",
        "testing"
      ]
    },
    {
      "id": "a267d7a5-9ae2-4f9f-8f9f-7d52681ed13c",
      "title": "Overview: Export & Import Implementation Plan",
      "passes": false,
      "overview": "Brain Dump is local-first with no built-in team collaboration. This feature enables async team sharing by letting users **export** an epic (or full project) as a portable `.braindump` file and **import** it into another Brain Dump instance. The export is a complete context bundle - everything an AI or human needs to pick up the work, minus operational noise (telemetry, sessions).\nKey user requirements:\n- Include comments, review findings, demos, attachments/images\n- Auto-tag imported tickets with `shared-by:{username}` for attribution and filtering\n- Handle re-imports (same epic name already exists) by letting user choose: create new, replace, or merge\n- 100MB archive size limit\n- Full end-to-end: core logic + CLI + UI\n---",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Implement as described",
        "Verify functionality works as expected"
      ],
      "references": [
        "src/api/transfer.ts",
        "src/lib/db.ts",
        "src/lib/hooks/transfer.ts",
        "src/lib/download.ts",
        "src/lib/hooks/index.ts",
        "src/components/transfer/ExportModal.tsx",
        "src/components/transfer/ImportModal.tsx",
        "src/components/EpicModal.tsx"
      ],
      "description": "# Epic/Project Export & Import (.braindump)\n\n## Context\n\nBrain Dump is local-first with no built-in team collaboration. This feature enables async team sharing by letting users **export** an epic (or full project) as a portable `.braindump` file and **import** it into another Brain Dump instance. The export is a complete context bundle - everything an AI or human needs to pick up the work, minus operational noise (telemetry, sessions).\n\nKey user requirements:\n- Include comments, review findings, demos, attachments/images\n- Auto-tag imported tickets with `shared-by:{username}` for attribution and filtering\n- Handle re-imports (same epic name already exists) by letting user choose: create new, replace, or merge\n- 100MB archive size limit\n- Full end-to-end: core logic + CLI + UI\n\n---\n\n## Manifest Format (.braindump = zip)\n\n```\nmy-epic.braindump (zip archive)\n├── manifest.json       # All structured data + metadata\n└── attachments/        # Binary files\n    └── {ticketId}/\n        └── filename.png\n```\n\n`manifest.json` structure:\n```typescript\n{\n  version: 1,\n  exportType: \"epic\" | \"project\",\n  exportedAt: string,         // ISO 8601\n  exportedBy: string,         // os.userInfo().username\n  appVersion: string,         // from package.json\n  sourceProject: { name: string },\n  epics: ExportedEpic[],\n  tickets: ExportedTicket[],  // full detail, tags parsed, git/PR fields stripped\n  comments: ExportedComment[],\n  reviewFindings: ExportedReviewFinding[],\n  demoScripts: ExportedDemoScript[],\n  workflowStates: ExportedWorkflowState[],\n  epicWorkflowStates: ExportedEpicWorkflowState[],\n  attachmentFiles: { archivePath, originalTicketId, filename }[]\n}\n```\n\n**Included**: epic metadata, tickets (full), acceptance criteria, comments, review findings, demo scripts, workflow states, epic learnings, attachment binaries\n**Excluded**: telemetry, Ralph sessions/events, conversation logs, Claude tasks/snapshots, git branch/PR/commit fields, linkedFiles (machine-specific paths), internal UUIDs (regenerated on import)\n\n---\n\n## Edge Cases\n\n| Case | Handling |\n|------|----------|\n| **Re-import (same epic name exists)** | Detect conflict, prompt user to choose: Create New / Replace / Merge |\n| **Replace mode** | Delete existing epic's tickets + related data, import fresh. Needs confirmation. |\n| **Merge mode** | Match tickets by title. New tickets added, existing updated with imported version. |\n| **Create New mode** | Import as separate epic with \" (from {username})\" suffix. Safe default. |\n| **Circular sharing** (A→B→A) | `shared-by:` tags accumulate, import comments provide audit trail |\n| **Archive >100MB** | Fail export with clear error, suggest removing large attachments |\n| **Missing attachment on disk** | Warn in export result but continue (don't fail the whole export) |\n| **Corrupt/invalid zip** | `InvalidArchiveError` with clear message |\n| **Future manifest version** | Reject with \"incompatible version\" error, suggest upgrading Brain Dump |\n| **Empty epic** (no tickets) | Allow export - creates archive with just epic metadata |\n| **Orphan tickets** (project export) | Include tickets with no epicId, import them as unassigned in target project |\n| **Tag stacking** on re-import | Accumulate `shared-by:` tags (don't deduplicate - shows full provenance) |\n| **Position conflicts** | Append imported tickets after highest existing position in the column |\n| **Duplicate import** (same file twice) | Fresh UUIDs each time, so no ID conflicts. User gets duplicates (merge mode handles this) |\n\n---\n\n## Implementation Plan\n\n### Phase 1: Foundation (core types + dependency)\n\n**1.1 Add jszip dependency**\n```bash\npnpm add jszip\n```\n- Single dependency handles both zip read and write\n- Ships with TypeScript types built-in\n\n**1.2 Create `core/transfer-types.ts`**\n- All manifest interfaces: `BrainDumpManifest`, `ExportedEpic`, `ExportedTicket`, `ExportedComment`, `ExportedReviewFinding`, `ExportedDemoScript`, `ExportedWorkflowState`, `ExportedEpicWorkflowState`, `ExportedAttachmentFile`\n- Param/result types: `ExportResult`, `ImportParams`, `ImportResult`, `ConflictResolution`\n\n**1.3 Add error classes to `core/errors.ts`**\n- `TransferError` (base for export/import errors)\n- `InvalidArchiveError` (corrupt zip, bad manifest version)\n- `ArchiveTooLargeError` (exceeds 100MB limit)\n\n**1.4 Update `core/index.ts`**\n- Export all new types and functions from transfer modules\n\n### Phase 2: Core Logic\n\n**2.1 Create `core/transfer.ts`** - Pure export/import business logic\n\nExport functions (no zip dependency - works with manifest + buffer map):\n- `gatherEpicExportData(db, { epicId })` → `ExportResult`\n  - Query epic + project for metadata\n  - Query all tickets for the epic\n  - For each ticket: query comments, review findings, demo scripts, workflow state\n  - Query epic workflow state (learnings)\n  - Read attachment files from disk into buffers\n  - Strip git/PR fields, parse JSON columns, auto-detect username\n  - Check total size against 100MB limit\n- `gatherProjectExportData(db, { projectId })` → `ExportResult`\n  - Same as above but for ALL epics + orphan tickets in the project\n\nImport function:\n- `importData(db, params: ImportParams)` → `ImportResult`\n  - Generate fresh UUIDs, build old→new ID map\n  - Detect epic name conflicts, apply `conflictResolution` strategy\n  - In a single transaction:\n    - Insert epics (mapped to target project)\n    - Insert tickets (remap epicId, append `shared-by:{username}` tag, clear git fields, recalculate positions)\n    - Insert comments (remap ticketId) + add provenance comment per ticket\n    - Insert review findings (remap ticketId)\n    - Insert demo scripts (remap ticketId)\n    - Insert workflow states (remap ticketId/epicId)\n  - Extract attachment files to `{attachmentsDir}/{newTicketId}/{filename}`\n  - Return counts + id map + warnings\n\nReuse existing functions:\n- `core/db.ts` → `getDataDir()` for attachment paths\n- `core/json.ts` → `safeJsonParse()` for JSON column handling\n- `core/git-utils.ts` → `slugify()` for filename generation\n\n**2.2 Create `core/transfer-zip.ts`** - Thin zip adapter\n\n- `createBrainDumpArchive(data: ExportResult)` → `Promise<Buffer>`\n- `extractBrainDumpArchive(zipBuffer: Buffer)` → `Promise<{ manifest, attachmentBuffers }>`\n- `previewBrainDumpArchive(zipBuffer: Buffer)` → `Promise<ManifestPreview>` (reads only manifest.json, skips attachments)\n\n### Phase 3: CLI\n\n**3.1 Create `cli/commands/transfer.ts`**\n\nActions: `export-epic`, `export-project`, `import`\n\nFlags:\n- `--epic <id>` / `--project <id>` / `--target-project <id>`\n- `--file <path>` (for import)\n- `--output <path>` (for export)\n- `--reset-statuses` (import: reset all to backlog)\n- `--conflict <create-new|replace|merge>` (import: how to handle existing epics)\n- `--pretty` (human-readable output)\n\nUses `runAsync` since jszip operations are async.\n\n**3.2 Update `cli/brain-dump.ts`**\n- Add `import * as transfer from \"./commands/transfer.ts\"`\n- Add `\"transfer\"` to `RESOURCES` array\n- Add `case \"transfer\": runAsync(transfer.handle, action, rest)` to switch\n- Add backward-compat shortcuts: `brain-dump export` and `brain-dump import`\n\n### Phase 4: Server Functions + Hooks\n\n**4.1 Create `src/api/transfer.ts`** - TanStack Start server functions\n\n4 server functions:\n- `exportEpic(epicId)` → `{ filename, data: base64, manifest summary }`\n- `exportProject(projectId)` → same shape\n- `previewImport(base64Data)` → manifest preview (epic names, counts, exporter info)\n- `performImport({ fileData, targetProjectId, resetStatuses, conflictResolution })` → `ImportResult`\n\nThe UI uses base64 encoding to transfer zip data between browser and server. Server functions pass `sqlite` (raw better-sqlite3 instance from `src/lib/db.ts`) to core functions.\n\n**4.2 Create `src/lib/hooks/transfer.ts`** - React Query mutations\n\n- `useExportEpic()` - mutation, triggers browser download on success\n- `useExportProject()` - mutation, triggers browser download on success\n- `usePreviewImport()` - mutation, returns manifest preview for UI\n- `usePerformImport()` - mutation, invalidates `queryKeys.allTickets`, `queryKeys.projects`, `queryKeys.allTags` on success\n\n**4.3 Create `src/lib/download.ts`** - Browser download utility\n\n- `downloadBase64File(base64Data, filename, mimeType)` - creates Blob, triggers `<a>` click download\n\n**4.4 Update `src/lib/hooks/index.ts`**\n- Add transfer hooks section with re-exports\n\n### Phase 5: UI Components\n\n**5.1 Create `src/components/transfer/ExportModal.tsx`**\n\nSimple confirmation modal shown when user clicks export:\n- Shows what will be exported (epic name, ticket count, attachment count)\n- Loading state while generating\n- Triggers browser download on success\n- Toast notification\n\n**5.2 Create `src/components/transfer/ImportModal.tsx`**\n\nMulti-step wizard modal:\n\n**Step 1 - File Selection:**\n- Drag-and-drop zone or file picker button\n- Accept only `.braindump` files\n- Read file, call `previewImport` to parse manifest\n\n**Step 2 - Preview & Options:**\n- Show: exporter name, source project, epic names, ticket/comment/finding/attachment counts\n- Project picker dropdown (required - which project to import into)\n- \"Reset all statuses to backlog\" toggle (default: off)\n- Conflict resolution radio (shown only if epic name conflict detected):\n  - \"Create as new epic\" (default, safe)\n  - \"Replace existing epic\" (with confirmation warning)\n  - \"Merge into existing epic\"\n\n**Step 3 - Result:**\n- Success: \"Imported X tickets into Y project\" with counts breakdown\n- Navigate to project or close\n\n**5.3 Update `src/components/EpicModal.tsx`**\n- Add \"Export\" option to the existing action dropdown menu (alongside Ralph launch options)\n- Opens ExportModal with the epic's ID\n\n**5.4 Add Import button to sidebar/navigation**\n- Add an \"Import\" button near the project list area\n- Uses Upload icon from lucide-react\n- Opens ImportModal\n\n**5.5 Add Project-level export**\n- Add \"Export Project\" to project context menu or ProjectModal\n- Opens ExportModal in project mode\n\n### Phase 6: Testing\n\n**6.1 Create `core/__tests__/transfer.test.ts`** - Core logic tests\n\nUsing `createTestDatabase()` from `core/db.ts`:\n\n- Export epic with tickets, comments, findings, demos → verify manifest structure\n- Export project with multiple epics + orphan tickets\n- Import into fresh project → verify all entities created with new IDs\n- Import with `resetStatuses: true` → verify all tickets in backlog\n- Import adds `shared-by:{username}` tag to every ticket\n- Import adds provenance comment to every ticket\n- Re-import with `conflictResolution: \"create-new\"` → creates separate epic\n- Re-import with `conflictResolution: \"replace\"` → old tickets removed, new inserted\n- Re-import with `conflictResolution: \"merge\"` → matching tickets updated, new added\n- Exported data excludes telemetry/sessions/conversation logs\n- Exported data excludes git/PR fields\n- Position calculation doesn't conflict with existing tickets\n- Archive size limit enforcement (>100MB rejected)\n- Missing attachment on disk → warning, not failure\n\n**6.2 Create `core/__tests__/transfer-zip.test.ts`** - Zip round-trip tests\n\n- Create export data → zip → extract → verify manifest matches\n- Attachments survive round-trip (binary integrity)\n- Invalid/corrupt zip rejected with clear error\n- Invalid manifest version rejected\n- Preview reads only manifest (fast, skips attachments)\n\n---\n\n## Files Summary\n\n### New Files (10)\n\n| File | Purpose |\n|------|---------|\n| `core/transfer-types.ts` | Manifest + param/result type definitions |\n| `core/transfer.ts` | Pure export/import business logic |\n| `core/transfer-zip.ts` | JSZip wrapper (create/extract/preview) |\n| `core/__tests__/transfer.test.ts` | Core logic tests |\n| `core/__tests__/transfer-zip.test.ts` | Zip round-trip tests |\n| `cli/commands/transfer.ts` | CLI command handler |\n| `src/api/transfer.ts` | TanStack Start server functions |\n| `src/lib/hooks/transfer.ts` | React Query mutations |\n| `src/lib/download.ts` | Browser file download utility |\n| `src/components/transfer/ExportModal.tsx` | Export confirmation + download modal |\n| `src/components/transfer/ImportModal.tsx` | Import wizard modal |\n\n### Modified Files (5)\n\n| File | Change |\n|------|--------|\n| `package.json` | Add `jszip` dependency |\n| `core/errors.ts` | Add `TransferError`, `InvalidArchiveError`, `ArchiveTooLargeError` |\n| `core/index.ts` | Export transfer module |\n| `cli/brain-dump.ts` | Add `transfer` resource + backward-compat shortcuts |\n| `src/lib/hooks/index.ts` | Re-export transfer hooks |\n| `src/components/EpicModal.tsx` | Add export button to action dropdown |\n\n---\n\n## Verification Plan\n\nAfter implementation, verify the full end-to-end flow:\n\n1. **Core tests**: `pnpm test core/__tests__/transfer.test.ts core/__tests__/transfer-zip.test.ts`\n2. **Type check**: `pnpm type-check`\n3. **Lint**: `pnpm lint`\n4. **CLI test**: `pnpm brain-dump transfer export-epic --epic <id> --pretty` then `pnpm brain-dump transfer import --file <path> --target-project <id> --pretty`\n5. **UI test** (manual at localhost:4242):\n   - Open an epic → action menu → Export → file downloads\n   - Click Import in sidebar → select the downloaded file → preview shows correctly → pick project → import → tickets appear on kanban board\n   - Verify `shared-by:` tags visible on imported ticket cards\n   - Filter by `shared-by:` tag → only imported tickets shown\n   - Re-import same file → conflict dialog appears → test all 3 resolution modes\n6. **Full check**: `pnpm check` (type-check + lint + all tests)\n\n---\n\n## Branch & PR Strategy\n\n**All tickets in this epic will be implemented on a single shared branch and submitted as one PR.** Use `workflow start-epic` to create the shared branch before starting the first ticket.",
      "priority": "high",
      "tags": [
        "overview",
        "reference",
        "do-not-implement"
      ]
    },
    {
      "id": "47e1bdf4-cf19-ae06-cd9d-e4c04b6f126e",
      "title": "Redesign sidebar import button for better discoverability",
      "passes": true,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Import button has visible label text (not just an icon)",
        "Button is visually distinct and clearly communicates its purpose",
        "Maintains visual harmony with the Add Project button",
        "Responsive - works well at different panel widths"
      ],
      "references": [],
      "description": "The current import .braindump button in the ProjectsPanel sidebar footer is a tiny icon-only button (Upload icon) with flex: 0, squeezed next to the \"Add Project\" button. It is easy to miss and looks like an afterthought.\n\n## Current State\n- Icon-only button with no label text\n- Only discoverable via hover tooltip (\"Import .braindump archive\")\n- Visually cramped next to Add Project\n\n## Acceptance Criteria\n- [ ] Import button has visible label text (not just an icon)\n- [ ] Button is visually distinct and clearly communicates its purpose\n- [ ] Maintains visual harmony with the Add Project button\n- [ ] Responsive - works well at different panel widths\n\n## Technical Notes\n- File: src/components/navigation/ProjectsPanel.tsx (lines 788-796)\n- The footer section uses flex layout with addButtonStyles\n- Consider: full-width button below Add Project, or a more prominent icon+label layout",
      "priority": "medium",
      "tags": []
    },
    {
      "id": "607e2442-67f0-2666-daa8-51d0c1174570",
      "title": "Add Import .braindump option to Create Project modal",
      "passes": true,
      "overview": "",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Create Project modal has two modes: New and Import",
        "Import mode shows drag-and-drop zone for .braindump files",
        "After file selection, preview shows archive contents (epic count, ticket count, etc.)",
        "User can customize project name and color before importing",
        "Conflict resolution options shown when applicable",
        "Successful import creates project and navigates to it",
        "Existing standalone ImportModal still works for importing into an EXISTING project"
      ],
      "references": [],
      "description": "The Create Project modal is the natural discovery point for importing a project. Users should be able to either create a new project from scratch OR import one from a .braindump archive, right from the same modal.\n\n## Current State\n- CreateProjectModal only supports creating new projects (name + path + color)\n- Import is only accessible via a small icon button in the sidebar footer\n- Users who want to import may not even know the feature exists\n\n## Proposed UX\n- Add a tab or toggle at the top of the Create Project modal: \"New Project\" | \"Import .braindump\"\n- The Import tab reuses the existing ImportModal file selection (drag and drop zone, file picker)\n- After selecting a file, show the preview with project name auto-filled from the archive\n- User can still pick color and override the project name\n- On import, a new project is created with the imported data\n\n## Acceptance Criteria\n- [ ] Create Project modal has two modes: New and Import\n- [ ] Import mode shows drag-and-drop zone for .braindump files\n- [ ] After file selection, preview shows archive contents (epic count, ticket count, etc.)\n- [ ] User can customize project name and color before importing\n- [ ] Conflict resolution options shown when applicable\n- [ ] Successful import creates project and navigates to it\n- [ ] Existing standalone ImportModal still works for importing into an EXISTING project\n\n## Technical Notes\n- Files: src/components/projects/CreateProjectModal.tsx, src/components/transfer/ImportModal.tsx\n- Reuse processFile, preview logic, and import mutation from ImportModal\n- Consider extracting shared import logic into a hook or shared component\n- The standalone ImportModal remains for importing into existing projects (e.g. from epic context menu)",
      "priority": "medium",
      "tags": []
    }
  ],
  "projectContext": {
    "techStack": [
      "Framework: TanStack Start (React 19 + Vite + Nitro)",
      "Database: SQLite with better-sqlite3, Drizzle ORM",
      "Styling: Tailwind CSS v4",
      "State: TanStack Query for server state",
      "Drag & Drop: @dnd-kit"
    ],
    "dosDonts": [
      {
        "category": "Database Queries",
        "dos": [
          "Use Drizzle ORM: `db.select().from(tickets)`",
          "Use typed schema imports: `import { tickets } from \"../lib/schema\"`",
          "Use `eq()`, `and()`, `sql` from drizzle-orm for conditions",
          "Use transactions for multi-table operations: `db.transaction(() => {...})`",
          "Use `.get()` for single row, `.all()` for multiple"
        ],
        "donts": [
          "Raw SQL strings: `db.run(\"SELECT * FROM tickets\")`",
          "String-based table names",
          "String concatenation for WHERE clauses",
          "Multiple independent queries that should be atomic",
          "Assume query returns what you expect without checking"
        ]
      },
      {
        "category": "React & TanStack Query",
        "dos": [
          "Use `useQuery` with `queryKeys` for data fetching",
          "Use `useMutation` with `onSuccess` for state changes",
          "Invalidate queries after mutations: `queryClient.invalidateQueries({ queryKey: queryKeys.tickets })`",
          "Use centralized `queryKeys` object from `src/lib/hooks.ts`",
          "Create custom hooks in `src/lib/hooks.ts` for reusable query logic"
        ],
        "donts": [
          "`useState` + `useEffect` for fetched data",
          "Direct API calls without proper cache invalidation",
          "Manual cache manipulation or refetch after every change",
          "Hardcoded query key strings throughout components",
          "Duplicate query setup in multiple components"
        ]
      },
      {
        "category": "Styling Patterns",
        "dos": [
          "Use Tailwind classes for static styles: `className=\"p-4 bg-slate-800\"`",
          "Use CSS variables for theming: `var(--bg-primary)`, `var(--shadow-modal)`",
          "Reserve inline styles for dynamic/computed values: `style={{ width: `${percent}%` }}`",
          "Define shared style constants at module level for referential stability",
          "Use `React.CSSProperties` type for inline style objects when needed"
        ],
        "donts": [
          "Inline style objects for single-use styles",
          "Hardcoded colors that don't adapt to themes",
          "Mix Tailwind and inline styles inconsistently",
          "Create new objects inside components that are reused",
          "Untyped style objects that miss IDE autocomplete"
        ]
      },
      {
        "category": "Server Functions",
        "dos": [
          "Use `createServerFn({ method: \"GET\" })` for reads, `\"POST\"` for writes",
          "Use `.inputValidator()` for type-safe input handling",
          "Return typed data directly: `return db.select().from(tickets).all()`",
          "Use `ensureExists()` for required lookups: `ensureExists(project, \"Project\")`",
          "Import from `@tanstack/react-start` (not `@tanstack/react-start/server`)"
        ],
        "donts": [
          "Mix GET/POST inconsistently",
          "Access raw input without validation",
          "Wrap in unnecessary response objects",
          "Return null and let caller handle missing data",
          "Wrong import path"
        ]
      },
      {
        "category": "MCP Tool Implementation",
        "dos": [
          "Use Zod schemas for input validation: `{ ticketId: z.string() }`",
          "Return structured `{ content: [{ type: \"text\", text: ... }] }` format",
          "Set `isError: true` for error responses",
          "Use `log.info()` / `log.error()` from `../lib/logging.js`",
          "Include helpful error messages: `\"Project not found. Use list_projects to see available.\"`"
        ],
        "donts": [
          "Trust input without validation",
          "Return plain strings",
          "Return error text without the error flag",
          "`console.log` in MCP server code",
          "Generic \"Not found\" errors"
        ]
      },
      {
        "category": "Testing Patterns (Kent C. Dodds)",
        "dos": [
          "Test user behavior: what users see, click, and experience",
          "Integration tests for workflows: test components together",
          "Real database fixtures with actual schema",
          "Tests that fail when user-facing behavior breaks",
          "Ask: \"Does this test catch bugs users would encounter?\""
        ],
        "donts": [
          "Test implementation details, internal state, or private methods",
          "Unit tests for every function",
          "Excessive mocking of internals",
          "Tests that break on refactoring internals",
          "Chase 100% code coverage as a goal"
        ]
      }
    ],
    "verificationSteps": [
      "Run `pnpm type-check` - must pass with no errors",
      "Run `pnpm lint` - must pass with no errors",
      "Run `pnpm test` - all tests must pass",
      "Added tests for new functionality (ONLY tests that verify real user behavior - see Testing Philosophy above)",
      "Used typed error classes (not generic `Error`)",
      "Used Drizzle ORM (not raw SQL) - see DO/DON'T table above",
      "Followed existing patterns from DO/DON'T tables",
      "No hardcoded values that should be configurable",
      "Existing tests still pass",
      "No regressions in related functionality",
      "Updated tests if behavior changed",
      "Did not break backward compatibility (unless explicitly requested)",
      "Manually verified in browser at `localhost:4242`",
      "Checked responsive layout",
      "Verified TanStack Query invalidates and updates correctly",
      "Accessibility: keyboard navigation works, proper ARIA labels",
      "Migration file created via `pnpm db:generate`",
      "Migration tested with `pnpm db:migrate`",
      "Backup tested if schema changed (use `pnpm brain-dump backup` then test restore)",
      "Updated `src/lib/schema.ts` with proper types and constraints",
      "Tested tool via Claude Code integration",
      "Verified error responses are informative (see DO/DON'T table)",
      "Updated tool documentation if interface changed",
      "Added Zod schema for input validation",
      "All acceptance criteria from ticket met",
      "Work summary added via `comment` tool, `action: \"add\"` (for Ralph sessions)",
      "Session completed with appropriate outcome (for Ralph sessions)",
      "Committed with proper message format: `feat(<ticket-id>): <description>`"
    ]
  },
  "generatedAt": "2026-02-13T21:46:09.747Z",
  "epicTitle": "Epic/Project Export & Import (.braindump)",
  "epicDescription": "Enable async team sharing by letting users export an epic (or full project) as a portable `.braindump` file and import it into another Brain Dump instance. The export is a complete context bundle - everything an AI or human needs to pick up the work, minus operational noise (telemetry, sessions).\n\nKey deliverables:\n- Core export/import logic with zip packaging\n- MCP tool (transfer) with 3 actions\n- CLI commands (export-epic, export-project, import)\n- UI components (ExportModal, ImportModal)\n- Conflict resolution (create-new, replace, merge)\n- shared-by:{username} attribution tagging\n- 100MB archive size limit\n\nAll tickets in this epic share a single branch and PR."
}

{
  "projectName": "Brain Dump",
  "projectPath": "/Users/salman.rana/code/brain-dump",
  "testingRequirements": [
    "Tests must validate user-facing behavior, not implementation details",
    "Focus on what users actually do - integration tests over unit tests",
    "Don't mock excessively - test real behavior where possible",
    "Coverage metrics are meaningless - user flow coverage is everything"
  ],
  "userStories": [
    {
      "id": "0fdb4a12-212a-48ba-8325-f7c1f6bf317a",
      "title": "Send ticket attachments to LLM in start_ticket_work",
      "passes": true,
      "overview": "When `start_ticket_work` is called, include any ticket attachments (screenshots, mockups, diagrams) in the MCP response so the LLM can see visual context.\nCurrently, attachments are stored but never sent to the LLM:\n- **Database:** `tickets.attachments` contains filenames like `[\"mockup.png\", \"design.jpg\"]`\n- **Filesystem:** Files stored at `~/.brain-dump/attachments/{ticketId}/`\n- **MCP Response:** Only returns text content, images are ignored",
      "types": [],
      "designDecisions": [
        {
          "decision": "This Matters",
          "alternatives": [],
          "rationale": []
        }
      ],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Read `ticket.attachments` JSON array when starting work",
        "Load image files from `~/.brain-dump/attachments/{ticketId}/`",
        "Convert images to base64 and include as MCP `image` content blocks",
        "Support common image formats: PNG, JPEG, GIF, WebP",
        "For non-image attachments (PDF, MD, TXT), include as text or reference",
        "Handle missing files gracefully (log warning, don't fail)",
        "Respect reasonable size limits (skip files > 5MB with warning)"
      ],
      "references": [
        "mcp-server/tools/workflow.js"
      ],
      "description": "## Overview\nWhen `start_ticket_work` is called, include any ticket attachments (screenshots, mockups, diagrams) in the MCP response so the LLM can see visual context.\n\n## Problem\nCurrently, attachments are stored but never sent to the LLM:\n- **Database:** `tickets.attachments` contains filenames like `[\"mockup.png\", \"design.jpg\"]`\n- **Filesystem:** Files stored at `~/.brain-dump/attachments/{ticketId}/`\n- **MCP Response:** Only returns text content, images are ignored\n\n## Acceptance Criteria\n- [ ] Read `ticket.attachments` JSON array when starting work\n- [ ] Load image files from `~/.brain-dump/attachments/{ticketId}/`\n- [ ] Convert images to base64 and include as MCP `image` content blocks\n- [ ] Support common image formats: PNG, JPEG, GIF, WebP\n- [ ] For non-image attachments (PDF, MD, TXT), include as text or reference\n- [ ] Handle missing files gracefully (log warning, don't fail)\n- [ ] Respect reasonable size limits (skip files > 5MB with warning)\n\n## Implementation Notes\n\n### MCP Image Content Block Format\n```javascript\n{\n  type: \"image\",\n  data: \"base64-encoded-image-data\",\n  mimeType: \"image/png\"\n}\n```\n\n### Files to Modify\n- `mcp-server/tools/workflow.js` - `start_ticket_work` handler (~line 234-348)\n\n### Pseudocode\n```javascript\n// In start_ticket_work handler, after getting ticket:\nconst contentBlocks = [];\n\n// Add main text content\ncontentBlocks.push({ type: \"text\", text: ticketDescription });\n\n// Add image attachments\nif (ticket.attachments) {\n  const attachments = JSON.parse(ticket.attachments);\n  for (const filename of attachments) {\n    const filePath = path.join(attachmentsDir, ticket.id, filename);\n    if (fs.existsSync(filePath) && isImage(filename)) {\n      const data = fs.readFileSync(filePath).toString('base64');\n      const mimeType = getMimeType(filename);\n      contentBlocks.push({ type: \"image\", data, mimeType });\n    }\n  }\n}\n\nreturn { content: contentBlocks };\n```\n\n## Testing\n- Create ticket with PNG attachment, start work, verify image appears in context\n- Create ticket with multiple attachments, verify all are included\n- Create ticket with missing attachment file, verify graceful handling\n- Create ticket with large file (>5MB), verify it's skipped with warning\n\n## Why This Matters\nFor UI tickets like Sprint 8 visual integration, the LLM needs to SEE the mockups to implement them accurately. Without this, we're describing visual designs in words when a picture would be worth 1000 tokens.\n\n\n## INSTRUCTIONs\nmake sure to createa a new branch that this will live in and a new github PR for this work",
      "priority": "high",
      "tags": [
        "mcp",
        "attachments",
        "workflow",
        "llm-context"
      ]
    }
  ],
  "projectContext": {
    "techStack": [
      "Framework: TanStack Start (React 19 + Vite + Nitro)",
      "Database: SQLite with better-sqlite3, Drizzle ORM",
      "Styling: Tailwind CSS v4",
      "State: TanStack Query for server state",
      "Drag & Drop: @dnd-kit"
    ],
    "dosDonts": [
      {
        "category": "Database Queries",
        "dos": [
          "Use Drizzle ORM: `db.select().from(tickets)`",
          "Use typed schema imports: `import { tickets } from \"../lib/schema\"`",
          "Use `eq()`, `and()`, `sql` from drizzle-orm for conditions",
          "Use transactions for multi-table operations: `db.transaction(() => {...})`",
          "Use `.get()` for single row, `.all()` for multiple"
        ],
        "donts": [
          "Raw SQL strings: `db.run(\"SELECT * FROM tickets\")`",
          "String-based table names",
          "String concatenation for WHERE clauses",
          "Multiple independent queries that should be atomic",
          "Assume query returns what you expect without checking"
        ]
      },
      {
        "category": "React & TanStack Query",
        "dos": [
          "Use `useQuery` with `queryKeys` for data fetching",
          "Use `useMutation` with `onSuccess` for state changes",
          "Invalidate queries after mutations: `queryClient.invalidateQueries({ queryKey: queryKeys.tickets })`",
          "Use centralized `queryKeys` object from `src/lib/hooks.ts`",
          "Create custom hooks in `src/lib/hooks.ts` for reusable query logic"
        ],
        "donts": [
          "`useState` + `useEffect` for fetched data",
          "Direct API calls without proper cache invalidation",
          "Manual cache manipulation or refetch after every change",
          "Hardcoded query key strings throughout components",
          "Duplicate query setup in multiple components"
        ]
      },
      {
        "category": "Styling Patterns",
        "dos": [
          "Use Tailwind classes for static styles: `className=\"p-4 bg-slate-800\"`",
          "Use CSS variables for theming: `var(--bg-primary)`, `var(--shadow-modal)`",
          "Reserve inline styles for dynamic/computed values: `style={{ width: `${percent}%` }}`",
          "Define shared style constants at module level for referential stability",
          "Use `React.CSSProperties` type for inline style objects when needed"
        ],
        "donts": [
          "Inline style objects for single-use styles",
          "Hardcoded colors that don't adapt to themes",
          "Mix Tailwind and inline styles inconsistently",
          "Create new objects inside components that are reused",
          "Untyped style objects that miss IDE autocomplete"
        ]
      },
      {
        "category": "Server Functions",
        "dos": [
          "Use `createServerFn({ method: \"GET\" })` for reads, `\"POST\"` for writes",
          "Use `.inputValidator()` for type-safe input handling",
          "Return typed data directly: `return db.select().from(tickets).all()`",
          "Use `ensureExists()` for required lookups: `ensureExists(project, \"Project\")`",
          "Import from `@tanstack/react-start` (not `@tanstack/react-start/server`)"
        ],
        "donts": [
          "Mix GET/POST inconsistently",
          "Access raw input without validation",
          "Wrap in unnecessary response objects",
          "Return null and let caller handle missing data",
          "Wrong import path"
        ]
      },
      {
        "category": "MCP Tool Implementation",
        "dos": [
          "Use Zod schemas for input validation: `{ ticketId: z.string() }`",
          "Return structured `{ content: [{ type: \"text\", text: ... }] }` format",
          "Set `isError: true` for error responses",
          "Use `log.info()` / `log.error()` from `../lib/logging.js`",
          "Include helpful error messages: `\"Project not found. Use list_projects to see available.\"`"
        ],
        "donts": [
          "Trust input without validation",
          "Return plain strings",
          "Return error text without the error flag",
          "`console.log` in MCP server code",
          "Generic \"Not found\" errors"
        ]
      },
      {
        "category": "Testing Patterns (Kent C. Dodds)",
        "dos": [
          "Test user behavior: what users see, click, and experience",
          "Integration tests for workflows: test components together",
          "Real database fixtures with actual schema",
          "Tests that fail when user-facing behavior breaks",
          "Ask: \"Does this test catch bugs users would encounter?\""
        ],
        "donts": [
          "Test implementation details, internal state, or private methods",
          "Unit tests for every function",
          "Excessive mocking of internals",
          "Tests that break on refactoring internals",
          "Chase 100% code coverage as a goal"
        ]
      }
    ],
    "verificationSteps": [
      "Run `pnpm type-check` - must pass with no errors",
      "Run `pnpm lint` - must pass with no errors",
      "Run `pnpm test` - all tests must pass",
      "Added tests for new functionality (ONLY tests that verify real user behavior - see Testing Philosophy above)",
      "Used typed error classes (not generic `Error`)",
      "Used Drizzle ORM (not raw SQL) - see DO/DON'T table above",
      "Followed existing patterns from DO/DON'T tables",
      "No hardcoded values that should be configurable",
      "Existing tests still pass",
      "No regressions in related functionality",
      "Updated tests if behavior changed",
      "Did not break backward compatibility (unless explicitly requested)",
      "Manually verified in browser at `localhost:4242`",
      "Checked responsive layout",
      "Verified TanStack Query invalidates and updates correctly",
      "Accessibility: keyboard navigation works, proper ARIA labels",
      "Migration file created via `pnpm db:generate`",
      "Migration tested with `pnpm db:migrate`",
      "Backup tested if schema changed (use `pnpm brain-dump backup` then test restore)",
      "Updated `src/lib/schema.ts` with proper types and constraints",
      "Tested tool via Claude Code integration",
      "Verified error responses are informative (see DO/DON'T table)",
      "Updated tool documentation if interface changed",
      "Added Zod schema for input validation",
      "All acceptance criteria from ticket met",
      "Work summary added via `add_ticket_comment` (for Ralph sessions)",
      "Session completed with appropriate outcome (for Ralph sessions)",
      "Committed with proper message format: `feat(<ticket-id>): <description>`"
    ]
  },
  "generatedAt": "2026-01-22T16:19:31.254Z"
}
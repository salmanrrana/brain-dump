{
  "projectName": "Brain Dump",
  "projectPath": "/Users/salman.rana/code/brain-dump",
  "testingRequirements": [
    "Tests must validate user-facing behavior, not implementation details",
    "Focus on what users actually do - integration tests over unit tests",
    "Don't mock excessively - test real behavior where possible",
    "Coverage metrics are meaningless - user flow coverage is everything"
  ],
  "userStories": [
    {
      "id": "984dcf9b-697f-4524-8c9a-c9fe4fec482c",
      "title": "Implement brain-dump-state-enforcement.ts plugin",
      "passes": true,
      "overview": "Create an OpenCode plugin that enforces the Universal Quality Workflow (UQW) state machine by blocking Write/Edit operations unless the Ralph session is in a valid code-writing state. This plugin replicates the Claude Code hook: `.claude/hooks/enforce-state-before-write.sh`\n- The Ralph state machine has specific states: `idle`, `analyzing`, `implementing`, `testing`, `committing`, `reviewing`, `done`\n- Only three states allow code writing: `implementing`, `testing`, `committing`\n- The state is tracked in `.claude/ralph-state.json` (shared across all environments)\n- When not in Ralph mode, the plugin should allow all operations (fail open)",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Plugin reads `.claude/ralph-state.json` before every Write/Edit attempt",
        "Blocks with helpful error message if in wrong state",
        "Allows operation if not in Ralph mode (graceful degradation)",
        "Error message includes exact MCP command to fix state",
        "Error message lists valid states for writing code",
        "Plugin follows OpenCode plugin structure and event hooks pattern"
      ],
      "references": [],
      "description": "## Overview\nCreate an OpenCode plugin that enforces the Universal Quality Workflow (UQW) state machine by blocking Write/Edit operations unless the Ralph session is in a valid code-writing state. This plugin replicates the Claude Code hook: `.claude/hooks/enforce-state-before-write.sh`\n\n## Context\n- The Ralph state machine has specific states: `idle`, `analyzing`, `implementing`, `testing`, `committing`, `reviewing`, `done`\n- Only three states allow code writing: `implementing`, `testing`, `committing`\n- The state is tracked in `.claude/ralph-state.json` (shared across all environments)\n- When not in Ralph mode, the plugin should allow all operations (fail open)\n\n## Acceptance Criteria\n- [ ] Plugin reads `.claude/ralph-state.json` before every Write/Edit attempt\n- [ ] Blocks with helpful error message if in wrong state\n- [ ] Allows operation if not in Ralph mode (graceful degradation)\n- [ ] Error message includes exact MCP command to fix state\n- [ ] Error message lists valid states for writing code\n- [ ] Plugin follows OpenCode plugin structure and event hooks pattern\n\n## Implementation Notes\n- File: `.opencode/plugins/brain-dump-state-enforcement.ts`\n- Hook: `tool.execute.before` (triggers before Write/Edit tools)\n- Valid states: `[\"implementing\", \"testing\", \"committing\"]`\n- Error format should match: `STATE ENFORCEMENT: You are in '{state}' state but tried to write/edit code.`\n- Include exact sessionId from state file in error message for quick copy-paste fix\n- Reference the telemetry plugin (`.opencode/plugins/brain-dump-telemetry.ts`) for OpenCode plugin patterns\n\n## Related\n- Ticket: \"Add UQW workflow guidance to AGENTS.md\" (documents expected errors)\n- Concept: Ralph session state machine (see CLAUDE.md Universal Quality Workflow section)\",\n<parameter name=\"priority\">high\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "opencode",
        "plugins",
        "enforcement"
      ]
    },
    {
      "id": "ec3ce586-d79b-4f9a-8179-e12f73f3f00e",
      "title": "Implement brain-dump-auto-pr.ts plugin",
      "passes": true,
      "overview": "Create an OpenCode plugin that automatically creates a draft GitHub PR when `start_ticket_work` completes successfully. This ensures PRs are created early and linked to tickets immediately, following the same workflow as Claude Code's `.claude/hooks/create-pr-on-ticket-start.sh`\n- `start_ticket_work` creates a git branch (e.g., `feature/abc123-ticket-slug`)\n- The auto-PR workflow runs immediately after branch creation\n- Draft PRs are auto-linked to tickets and update as new commits are pushed\n- This plugin communicates via `console.log()` (visible in OpenCode chat)",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Plugin triggers after `mcp__brain-dump__start_ticket_work` completes successfully",
        "Parses output to extract branch name, ticket ID, and ticket title",
        "Creates empty WIP commit with format: `feat(shortId): WIP - title`",
        "Pushes branch to remote with `-u` flag",
        "Creates draft PR via `gh pr create --draft`",
        "Outputs PR URL and branch name to console",
        "Handles failures gracefully (doesn't block workflow if git/gh fails)"
      ],
      "references": [],
      "description": "## Overview\nCreate an OpenCode plugin that automatically creates a draft GitHub PR when `start_ticket_work` completes successfully. This ensures PRs are created early and linked to tickets immediately, following the same workflow as Claude Code's `.claude/hooks/create-pr-on-ticket-start.sh`\n\n## Context\n- `start_ticket_work` creates a git branch (e.g., `feature/abc123-ticket-slug`)\n- The auto-PR workflow runs immediately after branch creation\n- Draft PRs are auto-linked to tickets and update as new commits are pushed\n- This plugin communicates via `console.log()` (visible in OpenCode chat)\n\n## Acceptance Criteria\n- [ ] Plugin triggers after `mcp__brain-dump__start_ticket_work` completes successfully\n- [ ] Parses output to extract branch name, ticket ID, and ticket title\n- [ ] Creates empty WIP commit with format: `feat(shortId): WIP - title`\n- [ ] Pushes branch to remote with `-u` flag\n- [ ] Creates draft PR via `gh pr create --draft`\n- [ ] Outputs PR URL and branch name to console\n- [ ] Handles failures gracefully (doesn't block workflow if git/gh fails)\n\n## Implementation Notes\n- File: `.opencode/plugins/brain-dump-auto-pr.ts`\n- Hook: `tool.execute.after` (triggers after MCP tool completes)\n- Parse ticket details from `start_ticket_work` output (multiple possible formats)\n- Commands: git commit, git push, gh pr create\n- Use `execSync` with `stdio: [\"pipe\", \"pipe\", \"pipe\"]` to suppress output\n- Output format: console.log with [Brain Dump] prefix for visibility\n- Reference the telemetry plugin for plugin structure patterns\n\n## Related\n- Concept: Git workflow integration\n- Concept: Draft PR tracking\",\n<parameter name=\"priority\">high\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "opencode",
        "plugins",
        "automation"
      ]
    },
    {
      "id": "64670dc9-cee5-4079-8e40-5bbf6d271c78",
      "title": "Implement brain-dump-commit-tracking.ts plugin",
      "passes": true,
      "overview": "Create an OpenCode plugin that outputs MCP commands to link commits to tickets after each git commit. This maintains an audit trail and helps the AI remember to link its work. Replicates `.claude/hooks/link-commit-to-ticket.sh`\n- After each git commit during Ralph session, suggest `link_commit_to_ticket()` MCP call\n- If a PR exists on the branch, also suggest `link_pr_to_ticket()` \n- Output is visible in OpenCode chat for AI to copy and use\n- This plugin only triggers when in Ralph mode (active session)",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Plugin triggers after Bash tool executes command containing `git commit`",
        "Checks if `.claude/ralph-state.json` exists (Ralph mode active)",
        "Gets latest commit hash via `git rev-parse --short HEAD`",
        "Gets latest commit message via `git log -1 --pretty=format:%B`",
        "Reads ticketId from state file",
        "Outputs suggested MCP command: `link_commit_to_ticket({ ticketId, commitHash })`",
        "Checks for PR on current branch via `gh pr list`",
        "If PR exists, outputs: `link_pr_to_ticket({ ticketId, prNumber })`",
        "Output clearly formatted with section headers for visibility",
        "Fails silently if not in Ralph mode or command fails"
      ],
      "references": [],
      "description": "## Overview\nCreate an OpenCode plugin that outputs MCP commands to link commits to tickets after each git commit. This maintains an audit trail and helps the AI remember to link its work. Replicates `.claude/hooks/link-commit-to-ticket.sh`\n\n## Context\n- After each git commit during Ralph session, suggest `link_commit_to_ticket()` MCP call\n- If a PR exists on the branch, also suggest `link_pr_to_ticket()` \n- Output is visible in OpenCode chat for AI to copy and use\n- This plugin only triggers when in Ralph mode (active session)\n\n## Acceptance Criteria\n- [ ] Plugin triggers after Bash tool executes command containing `git commit`\n- [ ] Checks if `.claude/ralph-state.json` exists (Ralph mode active)\n- [ ] Gets latest commit hash via `git rev-parse --short HEAD`\n- [ ] Gets latest commit message via `git log -1 --pretty=format:%B`\n- [ ] Reads ticketId from state file\n- [ ] Outputs suggested MCP command: `link_commit_to_ticket({ ticketId, commitHash })`\n- [ ] Checks for PR on current branch via `gh pr list`\n- [ ] If PR exists, outputs: `link_pr_to_ticket({ ticketId, prNumber })`\n- [ ] Output clearly formatted with section headers for visibility\n- [ ] Fails silently if not in Ralph mode or command fails\n\n## Implementation Notes\n- File: `.opencode/plugins/brain-dump-commit-tracking.ts`\n- Hook: `tool.execute.after` (triggers after Bash tool)\n- Check command contains: \\\"git commit\\\"\n- Use `execSync` with error handling (fail open)\n- Output format: console.log with clear borders for visibility\n- Extract commit info from `git log` commands\n- Reference the telemetry plugin for plugin structure\n\n## Related\n- Ticket: \\\"Implement brain-dump-commit-tracking.ts plugin\\\" (complements state enforcement)\n- Concept: Audit trail and commit tracking\",\n<parameter name=\"priority\">medium\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "opencode",
        "plugins",
        "automation"
      ]
    },
    {
      "id": "b867032f-c001-446e-8aad-304936bb1497",
      "title": "Implement brain-dump-review-marker.ts plugin",
      "passes": true,
      "overview": "Create an OpenCode plugin that automatically creates a `.claude/.review-completed` marker file after the AI review phase completes successfully. This marker is checked by the review guard plugin to allow/block git push operations.\n- After `check_review_complete` returns success, AI should be able to push code\n- The review guard plugin blocks push if code changes exist but review isn't complete\n- This plugin automates marker creation so AI doesn't need to manually create the file\n- Marker file contains timestamp for staleness checking (30-minute freshness in guard)",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Plugin triggers after `mcp__brain-dump__check_review_complete` completes",
        "Parses output to determine if review is complete",
        "Recognizes: `complete: true`, `canProceedToHumanReview: true`, or `openCritical === 0 && openMajor === 0`",
        "If review complete, creates/touches `.claude/.review-completed` marker file",
        "Marker file contains ISO timestamp",
        "Creates `.claude/` directory if it doesn't exist",
        "Outputs success message to console",
        "Handles errors gracefully (logs but doesn't break workflow)",
        "Does nothing if review is not complete"
      ],
      "references": [],
      "description": "## Overview\nCreate an OpenCode plugin that automatically creates a `.claude/.review-completed` marker file after the AI review phase completes successfully. This marker is checked by the review guard plugin to allow/block git push operations.\n\n## Context\n- After `check_review_complete` returns success, AI should be able to push code\n- The review guard plugin blocks push if code changes exist but review isn't complete\n- This plugin automates marker creation so AI doesn't need to manually create the file\n- Marker file contains timestamp for staleness checking (30-minute freshness in guard)\n\n## Acceptance Criteria\n- [ ] Plugin triggers after `mcp__brain-dump__check_review_complete` completes\n- [ ] Parses output to determine if review is complete\n- [ ] Recognizes: `complete: true`, `canProceedToHumanReview: true`, or `openCritical === 0 && openMajor === 0`\n- [ ] If review complete, creates/touches `.claude/.review-completed` marker file\n- [ ] Marker file contains ISO timestamp\n- [ ] Creates `.claude/` directory if it doesn't exist\n- [ ] Outputs success message to console\n- [ ] Handles errors gracefully (logs but doesn't break workflow)\n- [ ] Does nothing if review is not complete\n\n## Implementation Notes\n- File: `.opencode/plugins/brain-dump-review-marker.ts`\n- Hook: `tool.execute.after` (triggers after MCP tool)\n- Parse output: Handle both string (JSON format) and object formats\n- Create file at: `join(projectPath, \\\".claude\\\", \\\".review-completed\\\")`\n- Write timestamp: `new Date().toISOString()`\n- Use `mkdirSync` with `recursive: true`\n- Reference the telemetry plugin for patterns\n\n## Related\n- Ticket: \\\"Implement brain-dump-review-guard.ts plugin\\\" (uses this marker)\n- Concept: AI review workflow\",\n<parameter name=\"priority\">medium\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "opencode",
        "plugins",
        "review"
      ]
    },
    {
      "id": "33de0b4b-447b-400a-a3a4-3e13d7c4c178",
      "title": "Implement brain-dump-review-guard.ts plugin",
      "passes": true,
      "overview": "Create an OpenCode plugin that blocks git push/gh pr create until code review is complete. This ensures all code goes through the mandatory AI review phase before being pushed. Replicates `.claude/hooks/enforce-review-before-push.sh`\n- UQW requires code review before push: `in_progress` â†’ `ai_review` â†’ human review â†’ push\n- This plugin checks for uncommitted source code changes before push\n- If changes exist but no `.claude/.review-completed` marker, blocks with helpful error\n- Marker must be fresh (< 30 minutes old) for push to proceed",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Plugin triggers before Bash tool executes `git push` or `gh pr create`",
        "Gets uncommitted source file changes via `git diff`",
        "If no source code changes, allows push (nothing to review)",
        "Checks for `.claude/.review-completed` marker existence",
        "If marker doesn't exist, throws error with helpful message",
        "If marker exists but stale (> 30 minutes), throws error about fresh review needed",
        "If marker is fresh, allows push",
        "Error message includes review agent names or `/review` command",
        "Error guides user on what to do next",
        "Handles git/file errors gracefully"
      ],
      "references": [],
      "description": "## Overview\nCreate an OpenCode plugin that blocks git push/gh pr create until code review is complete. This ensures all code goes through the mandatory AI review phase before being pushed. Replicates `.claude/hooks/enforce-review-before-push.sh`\n\n## Context\n- UQW requires code review before push: `in_progress` â†’ `ai_review` â†’ human review â†’ push\n- This plugin checks for uncommitted source code changes before push\n- If changes exist but no `.claude/.review-completed` marker, blocks with helpful error\n- Marker must be fresh (< 30 minutes old) for push to proceed\n\n## Acceptance Criteria\n- [ ] Plugin triggers before Bash tool executes `git push` or `gh pr create`\n- [ ] Gets uncommitted source file changes via `git diff` \n- [ ] If no source code changes, allows push (nothing to review)\n- [ ] Checks for `.claude/.review-completed` marker existence\n- [ ] If marker doesn't exist, throws error with helpful message\n- [ ] If marker exists but stale (> 30 minutes), throws error about fresh review needed\n- [ ] If marker is fresh, allows push\n- [ ] Error message includes review agent names or `/review` command\n- [ ] Error guides user on what to do next\n- [ ] Handles git/file errors gracefully\n\n## Implementation Notes\n- File: `.opencode/plugins/brain-dump-review-guard.ts`\n- Hook: `tool.execute.before` (triggers before Bash tool)\n- Check commands: `git push` or `gh pr create`\n- Get changes: `git diff --name-only HEAD`\n- Filter source files: Exclude `package.json`, `*.md`, config files\n- Marker path: `join(projectPath, \\\".claude\\\", \\\".review-completed\\\")`\n- Staleness: Check file mtime is less than 30 minutes old\n- Error message format should guide AI to run review agents\n- Reference the telemetry plugin for plugin structure\n\n## Related\n- Ticket: \\\"Implement brain-dump-review-marker.ts plugin\\\" (creates marker this checks)\n- Concept: Code review workflow enforcement\",\n<parameter name=\"priority\">medium\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "opencode",
        "plugins",
        "enforcement",
        "review"
      ]
    },
    {
      "id": "a0b46674-873e-4540-941c-43249bc475de",
      "title": "Add UQW workflow guidance to AGENTS.md",
      "passes": true,
      "overview": "Create or update `.opencode/AGENTS.md` with comprehensive Universal Quality Workflow guidance for OpenCode. This document guides the AI through the complete Ralph session workflow, state transitions, and common errors.\n- Unlike Claude Code hooks that provide interactive feedback, OpenCode relies more on documentation\n- AGENTS.md is loaded by OpenCode's context system to guide AI behavior\n- Must explain state machine, valid transitions, error recovery, and the AI review process\n- This is critical for helping AI understand \\\"STATE ENFORCEMENT\\\" and \\\"CODE REVIEW REQUIRED\\\" errors",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Document Ralph state machine with all 7 states",
        "Explain which states allow code writing: `implementing`, `testing`, `committing`",
        "Provide exact error message examples and how to fix them",
        "Document complete AI review workflow with MCP commands",
        "Include self-review checklist for OpenCode (no external agents available)",
        "Explain why OpenCode needs more documentation (vs Claude Code's interactive hooks)",
        "Provide copy-paste command examples for common operations",
        "Format: Markdown with clear headers and code blocks",
        "Location: `.opencode/AGENTS.md`"
      ],
      "references": [],
      "description": "## Overview\nCreate or update `.opencode/AGENTS.md` with comprehensive Universal Quality Workflow guidance for OpenCode. This document guides the AI through the complete Ralph session workflow, state transitions, and common errors.\n\n## Context\n- Unlike Claude Code hooks that provide interactive feedback, OpenCode relies more on documentation\n- AGENTS.md is loaded by OpenCode's context system to guide AI behavior\n- Must explain state machine, valid transitions, error recovery, and the AI review process\n- This is critical for helping AI understand \\\"STATE ENFORCEMENT\\\" and \\\"CODE REVIEW REQUIRED\\\" errors\n\n## Sections to Include\n1. **Ralph Session Overview**: What is a Ralph session, when does it start\n2. **State Machine Diagram**: Explain all states and valid transitions\n3. **State Enforcement Rules**: Why Can't Write/Edit Unless In Valid State\n4. **Workflow Entry Point**: Always start with `start_ticket_work()`\n5. **Common Errors & Fixes**: \n   - \\\"STATE ENFORCEMENT: You are in 'analyzing' state\\\" â†’ Call update_session_state\n   - \\\"CODE REVIEW REQUIRED before push\\\" â†’ Run review agents\n   - \\\"Cannot generate demo - unresolved findings\\\" â†’ Fix critical/major findings\n6. **AI Review Workflow**: Submit findings â†’ Fix â†’ Verify â†’ Generate demo\n7. **Self-Review Checklist**: Error handling, type safety, edge cases, tests, performance\n\n## Acceptance Criteria\n- [ ] Document Ralph state machine with all 7 states\n- [ ] Explain which states allow code writing: `implementing`, `testing`, `committing`\n- [ ] Provide exact error message examples and how to fix them\n- [ ] Document complete AI review workflow with MCP commands\n- [ ] Include self-review checklist for OpenCode (no external agents available)\n- [ ] Explain why OpenCode needs more documentation (vs Claude Code's interactive hooks)\n- [ ] Provide copy-paste command examples for common operations\n- [ ] Format: Markdown with clear headers and code blocks\n- [ ] Location: `.opencode/AGENTS.md`\n\n## Implementation Notes\n- Write comprehensive but concise (reader is AI, not humans)\n- Use markdown code blocks for commands\n- Include examples from actual ticket workflows\n- Explain the \\\"why\\\" behind each rule\n- Cross-reference CLAUDE.md Universal Quality Workflow section\n- Explain difference between Claude Code hook enforcement and OpenCode plugin approach\n- Include troubleshooting section for unclear error messages\n\n## Related\n- Document: CLAUDE.md Universal Quality Workflow section\n- Concept: Ralph session state machine\",\n<parameter name=\"priority\">high\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "opencode",
        "documentation",
        "workflow"
      ]
    },
    {
      "id": "7e47f8c2-f886-4bd6-b013-2b080f7e826c",
      "title": "Create scripts/setup-opencode.sh installation script",
      "passes": true,
      "overview": "Create an automated setup script that installs OpenCode plugins and configures MCP server integration. This script detects the OpenCode environment, copies plugin files, and verifies the MCP configuration.\n- Brain Dump integrates with OpenCode via MCP server (similar to Claude Code)\n- Plugins should be installed to `.opencode/plugins/` or `~/.config/opencode/plugins/`\n- MCP config goes in `.opencode/opencode.json`\n- The main `scripts/install.sh` should detect OpenCode and call this script\n- Installation should be idempotent (safe to run multiple times)",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Script: `scripts/setup-opencode.sh` created and executable",
        "Detects OpenCode installation (command -v opencode)",
        "Determines plugin directory (`.opencode/plugins` or `~/.config/opencode/plugins`)",
        "Copies all 5 plugin files to plugin directory",
        "Creates/verifies `.opencode/opencode.json` with correct MCP config",
        "Creates/verifies `.opencode/AGENTS.md` with workflow guidance",
        "Outputs verification instructions and next steps",
        "Handles errors gracefully (creates directories if missing)",
        "Idempotent (safe to run multiple times)",
        "`scripts/install.sh` modified to detect and call this script"
      ],
      "references": [],
      "description": "## Overview\nCreate an automated setup script that installs OpenCode plugins and configures MCP server integration. This script detects the OpenCode environment, copies plugin files, and verifies the MCP configuration.\n\n## Context\n- Brain Dump integrates with OpenCode via MCP server (similar to Claude Code)\n- Plugins should be installed to `.opencode/plugins/` or `~/.config/opencode/plugins/`\n- MCP config goes in `.opencode/opencode.json`\n- The main `scripts/install.sh` should detect OpenCode and call this script\n- Installation should be idempotent (safe to run multiple times)\n\n## Acceptance Criteria\n- [ ] Script: `scripts/setup-opencode.sh` created and executable\n- [ ] Detects OpenCode installation (command -v opencode)\n- [ ] Determines plugin directory (`.opencode/plugins` or `~/.config/opencode/plugins`)\n- [ ] Copies all 5 plugin files to plugin directory\n- [ ] Creates/verifies `.opencode/opencode.json` with correct MCP config\n- [ ] Creates/verifies `.opencode/AGENTS.md` with workflow guidance\n- [ ] Outputs verification instructions and next steps\n- [ ] Handles errors gracefully (creates directories if missing)\n- [ ] Idempotent (safe to run multiple times)\n- [ ] `scripts/install.sh` modified to detect and call this script\n\n## MCP Config Template\n```json\n{\n  \\\"$schema\\\": \\\"https://opencode.ai/config.json\\\",\n  \\\"mcp\\\": {\n    \\\"brain-dump\\\": {\n      \\\"type\\\": \\\"local\\\",\n      \\\"command\\\": [\\\"npx\\\", \\\"tsx\\\", \\\"mcp-server/index.ts\\\"],\n      \\\"enabled\\\": true,\n      \\\"environment\\\": {\n        \\\"OPENCODE\\\": \\\"1\\\"\n      }\n    }\n  },\n  \\\"tools\\\": {\n    \\\"mcp__brain-dump__*\\\": true\n  }\n}\n```\n\n## Integration with scripts/install.sh\nAdd to `scripts/install.sh`:\n```bash\nif command -v opencode &> /dev/null; then\n  echo \\\"ðŸ“¦ Detected: OpenCode\\\"\n  ./scripts/setup-opencode.sh\nfi\n```\n\n## Implementation Notes\n- Use bash (consistent with other setup scripts)\n- Create directories with mkdir -p\n- Copy plugin files from `.opencode/plugins/`\n- Verify both plugin directory and opencode.json exist after setup\n- Output clear success/failure messages\n- Reference existing `scripts/setup-claude-code.sh` for patterns\n\n## Related\n- Script: `scripts/install.sh`\n- Concept: Multi-environment setup automation\",\n<parameter name=\"priority\">medium\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "opencode",
        "installation",
        "automation"
      ]
    },
    {
      "id": "da61b726-9999-46cd-a4ae-57755af8ae62",
      "title": "Document UQW differences between Claude Code and OpenCode",
      "passes": true,
      "overview": "Create comprehensive documentation explaining how the Universal Quality Workflow works in Claude Code vs OpenCode, and why the implementations differ. This helps users understand the trade-offs and capabilities of each environment.\n- Both Claude Code and OpenCode use the same MCP server and UQW workflow\n- Key difference: Claude Code uses shell hooks, OpenCode uses TypeScript plugins\n- Claude Code provides interactive feedback, OpenCode relies on console output + AGENTS.md\n- Both share the same `.claude/ralph-state.json` state file for consistency",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "Document created at: `docs/uqw-multi-environment.md`",
        "Overview section explains UQW (target: exists, why it matters)",
        "Claude Code section describes hook-based approach",
        "OpenCode section describes plugin-based approach",
        "Differences table clearly compares implementations",
        "Explains why different approaches needed (Claude Code can have hooks, OpenCode needs plugins)",
        "Troubleshooting covers most common issues",
        "Plugin reference documents all 5 plugins",
        "Markdown formatted with clear headers and code examples",
        "Cross-references CLAUDE.md UQW section",
        "Explains cross-environment consistency (same underlying system)"
      ],
      "references": [],
      "description": "## Overview\nCreate comprehensive documentation explaining how the Universal Quality Workflow works in Claude Code vs OpenCode, and why the implementations differ. This helps users understand the trade-offs and capabilities of each environment.\n\n## Context\n- Both Claude Code and OpenCode use the same MCP server and UQW workflow\n- Key difference: Claude Code uses shell hooks, OpenCode uses TypeScript plugins\n- Claude Code provides interactive feedback, OpenCode relies on console output + AGENTS.md\n- Both share the same `.claude/ralph-state.json` state file for consistency\n\n## Document Sections\n1. **Overview**: What is UQW and why it exists (applies to both)\n2. **Claude Code Implementation**: \n   - Hook-based enforcement (shell scripts in `.claude/hooks/`)\n   - Interactive feedback loop (blocks and shows error inline)\n   - How state enforcement works\n   - Auto-PR, commit tracking, review guard flows\n3. **OpenCode Implementation**:\n   - Plugin-based enforcement (TypeScript in `.opencode/plugins/`)\n   - Console-based feedback (output visible in chat)\n   - Why AGENTS.md guidance is critical\n   - Fallback when plugins aren't available\n4. **Key Differences Table**:\n   - Blocking mechanism (Claude: hook decision object, OpenCode: throw Error)\n   - Feedback to AI (Claude: injected context, OpenCode: console.log)\n   - State file location (both: `.claude/ralph-state.json`)\n   - Correlation ID tracking (Claude: text files, OpenCode: in-memory Map)\n   - Environment variables (Claude: CLAUDE_CODE=1, OpenCode: OPENCODE=1)\n   - AI guidance approach (Claude: hooks guide interactively, OpenCode: docs guide proactively)\n5. **Cross-Environment Consistency**:\n   - Same MCP server code\n   - Same database schema\n   - Same state file format\n   - Telemetry captured identically\n6. **Troubleshooting Guide**:\n   - Common errors and how to fix them in each environment\n   - Plugin loading issues in OpenCode\n   - Hook not triggering in Claude Code\n   - Missing state file issues\n7. **Plugin Reference**:\n   - Brief description of each plugin\n   - When each plugin triggers\n   - What it does and why\n\n## Acceptance Criteria\n- [ ] Document created at: `docs/uqw-multi-environment.md`\n- [ ] Overview section explains UQW (target: exists, why it matters)\n- [ ] Claude Code section describes hook-based approach\n- [ ] OpenCode section describes plugin-based approach\n- [ ] Differences table clearly compares implementations\n- [ ] Explains why different approaches needed (Claude Code can have hooks, OpenCode needs plugins)\n- [ ] Troubleshooting covers most common issues\n- [ ] Plugin reference documents all 5 plugins\n- [ ] Markdown formatted with clear headers and code examples\n- [ ] Cross-references CLAUDE.md UQW section\n- [ ] Explains cross-environment consistency (same underlying system)\n\n## Implementation Notes\n- Use markdown with clear hierarchy\n- Include diagrams/tables for comparison\n- Keep explanations concise (technical audience)\n- Focus on \\\"why\\\" not just \\\"what\\\"\n- Acknowledge both have advantages and limitations\n- This is lowest priority - can be done after all plugins work\n\n## Related\n- Document: CLAUDE.md (reference implementation)\n- Concept: Multi-environment architecture\",\n<parameter name=\"priority\">low\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": null,
      "tags": [
        "documentation",
        "comparison",
        "multi-environment"
      ]
    },
    {
      "id": "01118bbb-4887-47c8-919d-0ec8887532fb",
      "title": "OpenCode UQW Implementation Plan Overview",
      "passes": true,
      "overview": "This is the reference ticket containing the **COMPLETE** OpenCode Universal Quality Workflow implementation plan. This plan implements the UQW for OpenCode, ensuring it follows the same state-enforced workflow as Claude Code while leveraging OpenCode's plugin system and the existing MCP server infrastructure.\n**Key Insight**: The MCP server already handles ALL workflow logic (state transitions, validation, telemetry). OpenCode plugins only need to:\n1. **Enforce** state transitions (block Write/Edit unless in correct state)\n2. **Automate** PR workflows (auto-create PRs, track commits)\n3. **Guard** quality gates (block push until review complete)\n4. **Guide** the AI (via AGENTS.md rules)",
      "types": [],
      "designDecisions": [],
      "implementationGuide": [],
      "acceptanceCriteria": [
        "All 5 plugins created and follow OpenCode plugin structure",
        "Plugins read `.claude/ralph-state.json` and handle missing files gracefully",
        "State enforcement blocks Write/Edit unless in valid state",
        "Auto-PR creates draft PRs after `start_ticket_work`",
        "Commit tracking outputs MCP commands after commits",
        "Review marker creates `.claude/.review-completed` after review completes",
        "Review guard blocks push unless review marker exists and is fresh",
        "AGENTS.md created with all required sections",
        "Setup script installs plugins and configures MCP",
        "`scripts/install.sh` modified to detect and setup OpenCode",
        "All plugins handle errors gracefully (fail open, don't break workflow)",
        "Telemetry integration unchanged (plugins don't interfere with telemetry)",
        "Tested in actual OpenCode environment"
      ],
      "references": [
        "mcp-server/index.ts",
        "src/lib/schema.ts"
      ],
      "description": "## Overview\n\nThis is the reference ticket containing the **COMPLETE** OpenCode Universal Quality Workflow implementation plan. This plan implements the UQW for OpenCode, ensuring it follows the same state-enforced workflow as Claude Code while leveraging OpenCode's plugin system and the existing MCP server infrastructure.\n\n**Key Insight**: The MCP server already handles ALL workflow logic (state transitions, validation, telemetry). OpenCode plugins only need to:\n1. **Enforce** state transitions (block Write/Edit unless in correct state)\n2. **Automate** PR workflows (auto-create PRs, track commits)\n3. **Guard** quality gates (block push until review complete)\n4. **Guide** the AI (via AGENTS.md rules)\n\n## Current State\n\n### What Already Exists âœ…\n- **MCP Server**: Fully functional with all UQW tools (`start_ticket_work`, `complete_ticket_work`, `submit_review_finding`, `check_review_complete`, `generate_demo_script`, `submit_demo_feedback`, `reconcile_learnings`)\n- **Telemetry Plugin**: `.opencode/plugins/brain-dump-telemetry.ts` - comprehensive session and tool tracking\n- **State File**: `.claude/ralph-state.json` written by MCP server (shared across all environments)\n- **Database Schema**: `ticket_workflow_state`, `ralph_sessions`, `telemetry_sessions` tables\n- **Claude Code Hooks**: Reference implementation at `.claude/hooks/` for all enforcement patterns\n\n### What Needs Implementation ðŸš§\n- **5 Enforcement/Automation Plugins**: State enforcement, auto-PR, commit tracking, review marker, review guard\n- **AGENTS.md Guidance**: Comprehensive workflow documentation for OpenCode AI\n- **Setup Script**: Installation script for plugins and MCP config\n- **Integration**: Modify `scripts/install.sh` to detect and setup OpenCode\n\n## Critical Files to Create\n\n1. `.opencode/plugins/brain-dump-state-enforcement.ts` - Block Write/Edit unless in `implementing`/`testing`/`committing` state\n2. `.opencode/plugins/brain-dump-auto-pr.ts` - Auto-create draft PRs after `start_ticket_work`\n3. `.opencode/plugins/brain-dump-commit-tracking.ts` - Output MCP link commands after git commits\n4. `.opencode/plugins/brain-dump-review-marker.ts` - Auto-create `.claude/.review-completed` marker\n5. `.opencode/plugins/brain-dump-review-guard.ts` - Block push until code review complete\n6. `.opencode/AGENTS.md` - Comprehensive UQW workflow guidance\n7. `scripts/setup-opencode.sh` - Installation and configuration\n8. `scripts/install.sh` - Modify to include OpenCode detection\n\n## AI Review Workflow (Critical Phase)\n\nThe UQW includes a **mandatory AI review phase** between implementation and human review. The MCP server already implements all the logic.\n\n### Complete Flow: Implementation â†’ AI Review â†’ Human Review\n\n```\n1. complete_ticket_work(ticketId, summary)\n   â”œâ”€> Validates: pnpm type-check && pnpm lint && pnpm test\n   â”œâ”€> Updates ticket status: in_progress â†’ ai_review\n   â”œâ”€> Increments review_iteration\n   â””â”€> Creates/updates ticket_workflow_state\n\n2. Run 3 Review Agents (in parallel)\n   â”œâ”€> @code-reviewer (code quality, project guidelines)\n   â”œâ”€> @silent-failure-hunter (error handling, silent failures)\n   â””â”€> @code-simplifier (code clarity, unnecessary complexity)\n\n3. For each issue found:\n   submit_review_finding({\n     ticketId,\n     agent: \"code-reviewer\" | \"silent-failure-hunter\" | \"code-simplifier\",\n     severity: \"critical\" | \"major\" | \"minor\" | \"suggestion\",\n     category: \"type-safety\" | \"error-handling\" | \"performance\" | ...,\n     description: \"Detailed issue description\",\n     filePath: \"src/api/tickets.ts\",\n     lineNumber: 42,\n     suggestedFix: \"How to fix this issue\"\n   })\n   â””â”€> MCP validates: ticket must be in ai_review status\n   â””â”€> Increments findings_count\n   â””â”€> Stores finding in review_findings table\n\n4. Add findings summary to ticket:\n   add_ticket_comment({\n     ticketId,\n     content: \"## AI Review (Iteration 1)\\\\n\\\\nFound 3 issues:\\\\n- 1 critical\\\\n- 2 major\\\\n...\",\n     author: \"ralph\",\n     type: \"work_summary\"\n   })\n\n5. Fix all critical/major findings:\n   For each finding:\n     â”œâ”€> Write/Edit code to fix\n     â”œâ”€> Run tests to verify\n     â””â”€> mark_finding_fixed({\n           findingId,\n           status: \"fixed\",\n           fixDescription: \"...\"\n         })\n\n6. Verify all critical/major findings resolved:\n   check_review_complete({ ticketId })\n   â””â”€> Returns: { complete: true/false, openCritical: 0, openMajor: 0 }\n   â””â”€> If NOT complete â†’ Cannot proceed to demo\n   â””â”€> If complete â†’ Can generate demo script\n\n7. Generate demo script (only if review complete):\n   generate_demo_script({\n     ticketId,\n     steps: [\n       { order: 1, description: \"Open app\", expectedOutcome: \"...\", type: \"manual\" },\n       ...\n     ]\n   })\n   â””â”€> MPC validates: all critical/major findings fixed\n   â””â”€> Updates ticket status: ai_review â†’ human_review\n\n8. Human reviewer runs demo steps:\n   â””â”€> Manual testing via Brain Dump UI\n   â””â”€> Provides feedback via submit_demo_feedback\n\n9. Demo feedback determines final status:\n   submit_demo_feedback({\n     ticketId,\n     passed: true/false,\n     feedback: \"All tests passed\" | \"Issue found: ...\",\n     stepResults: [...]\n   })\n   â””â”€> If passed: ticket â†’ done\n   â””â”€> If failed: ticket stays in human_review\n```\n\n## Plugin Implementation Details\n\n### Step 1: State Enforcement Plugin (`.opencode/plugins/brain-dump-state-enforcement.ts`)\n- **Purpose**: Block Write/Edit unless Ralph session is in `implementing`/`testing`/`committing` state\n- **Hook**: `tool.execute.before` (triggers before Write/Edit tools)\n- **Valid States**: `[\"implementing\", \"testing\", \"committing\"]`\n- **Error Format**: `STATE ENFORCEMENT: You are in '{state}' state but tried to write/edit code.`\n- **Logic**: Read `.claude/ralph-state.json`, check currentState, throw Error if invalid, allow if not in Ralph mode (fail open)\n\n### Step 2: Auto-PR Plugin (`.opencode/plugins/brain-dump-auto-pr.ts`)\n- **Purpose**: Auto-create draft GitHub PR when `start_ticket_work` completes\n- **Hook**: `tool.execute.after` on `mcp__brain-dump__start_ticket_work`\n- **Workflow**: Parse output â†’ Create empty WIP commit â†’ Push branch â†’ Create draft PR â†’ Output PR URL\n- **Communication**: Via `console.log()` (visible in OpenCode chat)\n- **Graceful Failure**: Doesn't block workflow if git/gh fails\n\n### Step 3: Commit Tracking Plugin (`.opencode/plugins/brain-dump-commit-tracking.ts`)\n- **Purpose**: Output MCP commands to link commits to tickets after each git commit\n- **Hook**: `tool.execute.after` on Bash tool (when command contains `git commit`)\n- **Workflow**: Get latest commit hash/message â†’ Read ticketId from state â†’ Output suggested MCP commands\n- **Output**: Suggests both `link_commit_to_ticket()` and `link_pr_to_ticket()` (if PR exists)\n- **Graceful**: Fails silently if not in Ralph mode or git fails\n\n### Step 4: Review Marker Plugin (`.opencode/plugins/brain-dump-review-marker.ts`)\n- **Purpose**: Auto-create `.claude/.review-completed` marker after AI review completes\n- **Hook**: `tool.execute.after` on `mcp__brain-dump__check_review_complete`\n- **Logic**: Parse output â†’ Check if `complete: true` or `canProceedToHumanReview: true` â†’ Create marker file with timestamp\n- **File**: `.claude/.review-completed` (contains ISO timestamp)\n- **Used By**: Review guard plugin checks for this marker before allowing push\n\n### Step 5: Review Guard Plugin (`.opencode/plugins/brain-dump-review-guard.ts`)\n- **Purpose**: Block git push/gh pr create until code review is complete\n- **Hook**: `tool.execute.before` on Bash tool (when command contains `git push` or `gh pr create`)\n- **Validation**: Get uncommitted source changes â†’ Check for marker â†’ Verify freshness (< 30 min old)\n- **Error Message**: Guides user to run review agents or call `/review` command\n- **Graceful**: Allows push if no source code changes (nothing to review)\n\n## OpenCode vs Claude Code Differences\n\n| Aspect | Claude Code | OpenCode |\n|--------|-------------|----------|\n| Hook Type | Shell scripts in `.claude/hooks/` | TypeScript plugins in `.opencode/plugins/` |\n| Blocking Mechanism | Hook decision object `{\"decision\": \"block\"}` | `throw new Error()` |\n| Feedback to AI | Injected into chat context | `console.log()` visible in chat |\n| State File | `.claude/ralph-state.json` (same) | `.claude/ralph-state.json` (same) |\n| Correlation IDs | Text files (`.claude/tool-correlation-*.txt`) | In-memory Map |\n| Environment Var | `CLAUDE_CODE=1` | `OPENCODE=1` |\n| AI Guidance | Hooks provide interactive feedback | AGENTS.md critical for proactive guidance |\n| Interactivity | User sees blocking error inline, can fix and retry | AI must read error, understand, and fix |\n\n**Key Implication**: OpenCode plugins provide less interactive feedback. Therefore, **AGENTS.md guidance is CRITICAL**.\n\n## Setup Script Integration\n\n**Script**: `scripts/setup-opencode.sh`\n- Detects OpenCode installation\n- Determines plugin directory (`.opencode/plugins` or `~/.config/opencode/plugins`)\n- Copies all 5 plugin files\n- Creates/verifies `.opencode/opencode.json` with MCP config\n- Creates/verifies `.opencode/AGENTS.md` with workflow guidance\n- Outputs verification instructions\n\n**Integration into `scripts/install.sh`**:\n```bash\nif command -v opencode &> /dev/null; then\n  echo \\\"ðŸ“¦ Detected: OpenCode\\\"\n  ./scripts/setup-opencode.sh\nfi\n```\n\n**MCP Config Template** (in `.opencode/opencode.json`):\n```json\n{\n  \\\"$schema\\\": \\\"https://opencode.ai/config.json\\\",\n  \\\"mcp\\\": {\n    \\\"brain-dump\\\": {\n      \\\"type\\\": \\\"local\\\",\n      \\\"command\\\": [\\\"npx\\\", \\\"tsx\\\", \\\"mcp-server/index.ts\\\"],\n      \\\"enabled\\\": true,\n      \\\"environment\\\": {\n        \\\"OPENCODE\\\": \\\"1\\\"\n      }\n    }\n  },\n  \\\"tools\\\": {\n    \\\"mcp__brain-dump__*\\\": true\n  }\n}\n```\n\n## AGENTS.md Content Structure\n\nThe `.opencode/AGENTS.md` document should include:\n\n1. **Ralph Session Overview** - What is a Ralph session, when it starts, why it matters\n2. **State Machine Diagram** - All 7 states and valid transitions\n3. **State Enforcement Rules** - Why Write/Edit only allowed in certain states\n4. **Workflow Entry Point** - Always start with `start_ticket_work()`\n5. **Common Errors & Fixes**:\n   - \\\"STATE ENFORCEMENT: You are in 'analyzing' state\\\" â†’ Call `update_session_state`\n   - \\\"CODE REVIEW REQUIRED before push\\\" â†’ Run review agents\n   - \\\"Cannot generate demo - unresolved findings\\\" â†’ Fix critical/major findings\n6. **AI Review Workflow** - Complete workflow with MCP commands\n7. **Self-Review Checklist** - Error handling, type safety, edge cases, tests, performance\n8. **Troubleshooting** - Unclear errors, plugins not loading, missing state file\n\n## Verification Checklist (for Implementation)\n\n- [ ] All 5 plugins created and follow OpenCode plugin structure\n- [ ] Plugins read `.claude/ralph-state.json` and handle missing files gracefully\n- [ ] State enforcement blocks Write/Edit unless in valid state\n- [ ] Auto-PR creates draft PRs after `start_ticket_work`\n- [ ] Commit tracking outputs MCP commands after commits\n- [ ] Review marker creates `.claude/.review-completed` after review completes\n- [ ] Review guard blocks push unless review marker exists and is fresh\n- [ ] AGENTS.md created with all required sections\n- [ ] Setup script installs plugins and configures MCP\n- [ ] `scripts/install.sh` modified to detect and setup OpenCode\n- [ ] All plugins handle errors gracefully (fail open, don't break workflow)\n- [ ] Telemetry integration unchanged (plugins don't interfere with telemetry)\n- [ ] Tested in actual OpenCode environment\n\n## Success Criteria\n\nâœ… OpenCode enforces same UQW state transitions as Claude Code\nâœ… All 5 plugins integrate seamlessly with existing MCP server\nâœ… Telemetry captures all tool usage and prompts\nâœ… Auto-PR workflow creates draft PRs when work starts\nâœ… Commit tracking helps maintain audit trail\nâœ… Review guard prevents pushing unreviewed code\nâœ… AGENTS.md provides clear guidance for common errors\nâœ… Installation script detects OpenCode and configures automatically\nâœ… Both Claude Code and OpenCode share same state file and workflow\n\n## Epic Structure\n\n**Epic**: \\\"OpenCode Universal Quality Workflow\\\" (ID: `fe789e29-355f-4e2c-9764-e665d7c58d39`)\n\n**Branch**: `feature/epic-fe789e29-opencode-universal-quality-workflow`\n\n**Tickets** (8 total):\n1. Overview ticket (this one) - Reference document\n2. State enforcement plugin implementation\n3. Auto-PR plugin implementation\n4. Commit tracking plugin implementation\n5. Review marker plugin implementation\n6. Review guard plugin implementation\n7. AGENTS.md guidance documentation\n8. Setup script and installation integration\n9. (Optional) Documentation comparing Claude Code vs OpenCode differences\n\n## Key References\n\n- **Telemetry Plugin**: `.opencode/plugins/brain-dump-telemetry.ts` (reference for plugin structure)\n- **Claude Code Hooks**: `.claude/hooks/` (reference implementations to replicate)\n- **CLAUDE.md**: Universal Quality Workflow section (architecture and workflow details)\n- **MCP Server**: `mcp-server/index.ts` (all workflow logic already implemented)\n- **Database Schema**: `src/lib/schema.ts` (workflow state tables)\n\n## Additional INformation\nhave all code live in branch \"feature/64670dc9-implement-brain-dump-commit-tracking-ts-plugin\"",
      "priority": "high",
      "tags": [
        "documentation",
        "planning",
        "opencode",
        "reference"
      ]
    }
  ],
  "projectContext": {
    "techStack": [
      "Framework: TanStack Start (React 19 + Vite + Nitro)",
      "Database: SQLite with better-sqlite3, Drizzle ORM",
      "Styling: Tailwind CSS v4",
      "State: TanStack Query for server state",
      "Drag & Drop: @dnd-kit"
    ],
    "dosDonts": [
      {
        "category": "Database Queries",
        "dos": [
          "Use Drizzle ORM: `db.select().from(tickets)`",
          "Use typed schema imports: `import { tickets } from \"../lib/schema\"`",
          "Use `eq()`, `and()`, `sql` from drizzle-orm for conditions",
          "Use transactions for multi-table operations: `db.transaction(() => {...})`",
          "Use `.get()` for single row, `.all()` for multiple"
        ],
        "donts": [
          "Raw SQL strings: `db.run(\"SELECT * FROM tickets\")`",
          "String-based table names",
          "String concatenation for WHERE clauses",
          "Multiple independent queries that should be atomic",
          "Assume query returns what you expect without checking"
        ]
      },
      {
        "category": "React & TanStack Query",
        "dos": [
          "Use `useQuery` with `queryKeys` for data fetching",
          "Use `useMutation` with `onSuccess` for state changes",
          "Invalidate queries after mutations: `queryClient.invalidateQueries({ queryKey: queryKeys.tickets })`",
          "Use centralized `queryKeys` object from `src/lib/hooks.ts`",
          "Create custom hooks in `src/lib/hooks.ts` for reusable query logic"
        ],
        "donts": [
          "`useState` + `useEffect` for fetched data",
          "Direct API calls without proper cache invalidation",
          "Manual cache manipulation or refetch after every change",
          "Hardcoded query key strings throughout components",
          "Duplicate query setup in multiple components"
        ]
      },
      {
        "category": "Styling Patterns",
        "dos": [
          "Use Tailwind classes for static styles: `className=\"p-4 bg-slate-800\"`",
          "Use CSS variables for theming: `var(--bg-primary)`, `var(--shadow-modal)`",
          "Reserve inline styles for dynamic/computed values: `style={{ width: `${percent}%` }}`",
          "Define shared style constants at module level for referential stability",
          "Use `React.CSSProperties` type for inline style objects when needed"
        ],
        "donts": [
          "Inline style objects for single-use styles",
          "Hardcoded colors that don't adapt to themes",
          "Mix Tailwind and inline styles inconsistently",
          "Create new objects inside components that are reused",
          "Untyped style objects that miss IDE autocomplete"
        ]
      },
      {
        "category": "Server Functions",
        "dos": [
          "Use `createServerFn({ method: \"GET\" })` for reads, `\"POST\"` for writes",
          "Use `.inputValidator()` for type-safe input handling",
          "Return typed data directly: `return db.select().from(tickets).all()`",
          "Use `ensureExists()` for required lookups: `ensureExists(project, \"Project\")`",
          "Import from `@tanstack/react-start` (not `@tanstack/react-start/server`)"
        ],
        "donts": [
          "Mix GET/POST inconsistently",
          "Access raw input without validation",
          "Wrap in unnecessary response objects",
          "Return null and let caller handle missing data",
          "Wrong import path"
        ]
      },
      {
        "category": "MCP Tool Implementation",
        "dos": [
          "Use Zod schemas for input validation: `{ ticketId: z.string() }`",
          "Return structured `{ content: [{ type: \"text\", text: ... }] }` format",
          "Set `isError: true` for error responses",
          "Use `log.info()` / `log.error()` from `../lib/logging.js`",
          "Include helpful error messages: `\"Project not found. Use list_projects to see available.\"`"
        ],
        "donts": [
          "Trust input without validation",
          "Return plain strings",
          "Return error text without the error flag",
          "`console.log` in MCP server code",
          "Generic \"Not found\" errors"
        ]
      },
      {
        "category": "Testing Patterns (Kent C. Dodds)",
        "dos": [
          "Test user behavior: what users see, click, and experience",
          "Integration tests for workflows: test components together",
          "Real database fixtures with actual schema",
          "Tests that fail when user-facing behavior breaks",
          "Ask: \"Does this test catch bugs users would encounter?\""
        ],
        "donts": [
          "Test implementation details, internal state, or private methods",
          "Unit tests for every function",
          "Excessive mocking of internals",
          "Tests that break on refactoring internals",
          "Chase 100% code coverage as a goal"
        ]
      }
    ],
    "verificationSteps": [
      "Run `pnpm type-check` - must pass with no errors",
      "Run `pnpm lint` - must pass with no errors",
      "Run `pnpm test` - all tests must pass",
      "Added tests for new functionality (ONLY tests that verify real user behavior - see Testing Philosophy above)",
      "Used typed error classes (not generic `Error`)",
      "Used Drizzle ORM (not raw SQL) - see DO/DON'T table above",
      "Followed existing patterns from DO/DON'T tables",
      "No hardcoded values that should be configurable",
      "Existing tests still pass",
      "No regressions in related functionality",
      "Updated tests if behavior changed",
      "Did not break backward compatibility (unless explicitly requested)",
      "Manually verified in browser at `localhost:4242`",
      "Checked responsive layout",
      "Verified TanStack Query invalidates and updates correctly",
      "Accessibility: keyboard navigation works, proper ARIA labels",
      "Migration file created via `pnpm db:generate`",
      "Migration tested with `pnpm db:migrate`",
      "Backup tested if schema changed (use `pnpm brain-dump backup` then test restore)",
      "Updated `src/lib/schema.ts` with proper types and constraints",
      "Tested tool via Claude Code integration",
      "Verified error responses are informative (see DO/DON'T table)",
      "Updated tool documentation if interface changed",
      "Added Zod schema for input validation",
      "All acceptance criteria from ticket met",
      "Work summary added via `add_ticket_comment` (for Ralph sessions)",
      "Session completed with appropriate outcome (for Ralph sessions)",
      "Committed with proper message format: `feat(<ticket-id>): <description>`"
    ]
  },
  "generatedAt": "2026-02-01T08:18:34.927Z",
  "epicTitle": "OpenCode Universal Quality Workflow",
  "epicDescription": "Implement the Universal Quality Workflow for OpenCode, ensuring it follows the same state-enforced workflow as Claude Code. Leverages OpenCode's plugin system to replicate hook-based enforcement while reusing the existing MCP server infrastructure."
}
